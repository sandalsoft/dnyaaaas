function s(e,o,n){var t,i=e.data;return o?(t=new Buffer(1),t[0]=r[e.type],n(Buffer.concat([t,i]))):exports.encodeBase64Packet(e,n)}function i(e,a,i){var o,n,t,s=void 0===e.data?void 0:e.data.buffer||e.data;if(!a)return exports.encodeBase64Packet(e,i);for(o=new Uint8Array(s),n=new Buffer(1+s.byteLength),n[0]=r[e.type],t=0;t<o.length;t++)n[t+1]=o[t];return i(n)}function n(t,n,o){var e,r=Array(t.length),i=u(t.length,o),s=function(e,t,o){n(t,function(t,n){r[e]=n,o(t,r)})};for(e=0;e<t.length;e++)s(e,t[e],i)}function a(t){var e,r="";for(e=0;e<t.length;e++)r+=String.fromCharCode(t[e]);return r}function c(t){var e,r=new Buffer(t.length);for(e=0;e<t.length;e++)r.writeUInt8(t.charCodeAt(e),e);return r}var r,t,e,o=require("utf8"),u=require("after"),l=require("./keys");exports.protocol=3,r=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},t=l(r),e={type:"error",data:"parser error"},exports.encodePacket=function(e,t,n){var a,c;return"function"==typeof t&&(n=t,t=null),a=void 0===e.data?void 0:e.data.buffer||e.data,Buffer.isBuffer(a)?s(e,t,n):a instanceof ArrayBuffer?i(e,t,n):(c=r[e.type],void 0!==e.data&&(c+=o.encode(e.data+"")),n(""+c))},exports.encodeBase64Packet=function(e,s){var n,t,o,i=e.data.buffer||e.data;if(i instanceof ArrayBuffer){for(n=new Buffer(i.byteLength),t=0;t<n.length;t++)n[t]=i[t];e.data=n}return o="b"+r[e.type],o+=e.data.toString("base64"),s(o)},exports.decodePacket=function(r,a){var n,s,i;if("string"==typeof r||void 0===r)return"b"==r.charAt(0)?exports.decodeBase64Packet(r.substr(1),a):(n=r.charAt(0),r=o.decode(r),+n==n&&t[n]?r.length>1?{type:t[n],data:r.substring(1)}:{type:t[n]}:e);if("arraybuffer"===a){for(n=r[0],s=new Uint8Array(r.length-1),i=1;i<r.length;i++)s[i-1]=r[i];return{type:t[n],data:s.buffer}}return n=r[0],{type:t[n],data:r.slice(1)}},exports.decodeBase64Packet=function(o,i){var r,e,s=t[o.charAt(0)],n=new Buffer(o.substr(1),"base64");if("arraybuffer"===i){for(r=new Uint8Array(n.length),e=0;e<r.length;e++)r[e]=n[e];n=r.buffer}return{type:s,data:n}},exports.encodePayload=function(r,e,t){function o(e){return e.length+":"+e}function i(t,r){exports.encodePacket(t,e,function(e){r(null,o(e))})}return"function"==typeof e&&(t=e,e=null),e?exports.encodePayloadAsBinary(r,t):r.length?void n(r,i,function(r,e){return t(e.join(""))}):t("0:")},exports.decodePayload=function(o,i,t){var s,r,c,a,n,u,l,p;if("string"!=typeof o)return exports.decodePayloadAsBinary(o,i,t);if("function"==typeof i&&(t=i,i=null),""==o)return t(e,0,1);for(r="",n=0,u=o.length;u>n;n++)if(l=o.charAt(n),":"!=l)r+=l;else{if(""==r||r!=(c=+r))return t(e,0,1);if(a=o.substr(n+1,c),r!=a.length)return t(e,0,1);if(a.length){if(s=exports.decodePacket(a,i),e.type==s.type&&e.data==s.data)return t(e,0,1);if(p=t(s,n+c,u),!1===p)return}n+=c,r=""}return""!=r?t(e,0,1):void 0},exports.encodePayloadAsBinary=function(e,t){function r(t,e){exports.encodePacket(t,!0,function(o){var n,t,r;if("string"==typeof o){for(n=""+o.length,t=new Buffer(n.length+2),t[0]=0,r=0;r<n.length;r++)t[r+1]=parseInt(n[r],10);return t[t.length-1]=255,e(null,Buffer.concat([t,c(o)]))}for(n=""+o.length,t=new Buffer(n.length+2),t[0]=1,r=0;r<n.length;r++)t[r+1]=parseInt(n[r],10);t[t.length-1]=255,e(null,Buffer.concat([t,o]))})}return e.length?void n(e,r,function(r,e){return t(Buffer.concat(e))}):t(new Buffer(0))},exports.decodePayloadAsBinary=function(p,n,c){var e,r,t,l,o,s,i,u;for("function"==typeof n&&(c=n,n=null),e=p,r=[];e.length>0;){for(t="",l=0===e[0],o=1;255!=e[o];o++)t+=""+e[o];e=e.slice(t.length+1),s=parseInt(t,10),i=e.slice(1,s+1),l&&(i=a(i)),r.push(i),e=e.slice(s+1)}u=r.length,r.forEach(function(e,t){c(exports.decodePacket(e,n),t,u)})};