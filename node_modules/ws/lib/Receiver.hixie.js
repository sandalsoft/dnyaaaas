function e(){this.state=t,this.buffers=[],this.messageEnd=-1,this.spanLength=0,this.dead=!1,this.onerror=function(){},this.ontext=function(){},this.onbinary=function(){},this.onclose=function(){},this.onping=function(){},this.onpong=function(){}}function i(t,r){for(var e=0,n=t.length;n>e;++e)if(t[e]===r)return e;return-1}var s=require("util"),t=0,r=1,n=2,o=3;module.exports=e,e.prototype.add=function(s){function a(){var a,c;if(e.state===t){if(2==s.length&&255==s[0]&&0==s[1])return e.reset(),void e.onclose();if(128===s[0])e.messageEnd=0,e.state=n,s=s.slice(1);else{if(0!==s[0])return void e.error("payload must start with 0x00 byte",!0);s=s.slice(1),e.state=r}}if(e.state===n){for(a=0;a<s.length&&128&s[a];)e.messageEnd=128*e.messageEnd+(127&s[a]),++a;a<s.length&&(e.messageEnd=128*e.messageEnd+(127&s[a]),e.state=o,++a),a>0&&(s=s.slice(a))}return e.state===o?(c=e.messageEnd-e.spanLength,s.length>=c?(e.buffers.push(s),e.spanLength+=c,e.messageEnd=c,e.parse()):(e.buffers.push(s),void(e.spanLength+=s.length))):(e.buffers.push(s),-1!=(e.messageEnd=i(s,255))?(e.spanLength+=e.messageEnd,e.parse()):void(e.spanLength+=s.length))}for(var e=this;s;)s=a()},e.prototype.cleanup=function(){this.dead=!0,this.state=t,this.buffers=[]},e.prototype.parse=function(){var e,a,n,t,o,i=new Buffer(this.spanLength),s=0;for(e=0,a=this.buffers.length;a-1>e;++e)n=this.buffers[e],n.copy(i,s),s+=n.length;return t=this.buffers[this.buffers.length-1],this.messageEnd>0&&t.copy(i,s,0,this.messageEnd),this.state!==r&&--this.messageEnd,o=null,this.messageEnd<t.length-1&&(o=t.slice(this.messageEnd+1)),this.reset(),this.ontext(i.toString("utf8")),o},e.prototype.error=function(e,t){return this.reset(),this.onerror(e,t),this},e.prototype.reset=function(){this.dead||(this.state=t,this.buffers=[],this.messageEnd=-1,this.spanLength=0)};