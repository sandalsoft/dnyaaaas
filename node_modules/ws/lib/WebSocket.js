function e(t,e,r){e&&!Array.isArray(e)&&"object"==typeof e&&(r=e,e=null),"string"==typeof e&&(e=[e]),Array.isArray(e)||(e=[]),this._socket=null,this.bytesReceived=0,this.readyState=null,this.supports={},Array.isArray(t)?_.apply(this,t.concat(r)):b.apply(this,[t,e,r])}function h(e,t,r){this.data=e,this.type=t,this.target=r}function w(e,t,r){this.wasClean=void 0===e||1e3==e,this.code=e,this.reason=t,this.target=r}function d(e){this.target=e}function _(i,r,n,t){t=new a({protocolVersion:l,protocol:null}).merge(t),this.protocol=t.value.protocol,this.protocolVersion=t.value.protocolVersion,this.supports.binary="hixie-76"!=this.protocolVersion,this.upgradeReq=i,this.readyState=e.CONNECTING,this._isServer=!0,"hixie-76"==t.value.protocolVersion?o.call(this,E,k,r,n):o.call(this,u,c,r,n)}function b(A,T,i){var f,S,x,k,b,q,_,C,O,h,w,s,E,d,v;if(i=new a({origin:null,protocolVersion:l,host:null,headers:null,protocol:null,agent:null,pfx:null,key:null,passphrase:null,cert:null,ca:null,ciphers:null,rejectUnauthorized:null}).merge(i),8!=i.value.protocolVersion&&13!=i.value.protocolVersion)throw Error("unsupported protocol version");if(f=m.parse(A),S="ws+unix:"===f.protocol,!f.host&&!S)throw Error("invalid url");if(x="wss:"===f.protocol||"https:"===f.protocol,k=x?g:p,b=f.port||(x?443:80),q=f.auth,this._isServer=!1,this.url=A,this.protocolVersion=i.value.protocolVersion,this.supports.binary="hixie-76"!=this.protocolVersion,_=new Buffer(i.value.protocolVersion+"-"+Date.now()).toString("base64"),C=y.createHash("sha1"),C.update(_+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),O=C.digest("base64"),h=i.value.agent,!h&&t&&(t=!0,h=new k.Agent({host:f.hostname,port:b})),w=f.hostname,f.port&&(x&&443!=b||!x&&80!=b)&&(w=w+":"+b),s={port:b,host:f.hostname,headers:{Connection:"Upgrade",Upgrade:"websocket",Host:w,Origin:w,"Sec-WebSocket-Version":i.value.protocolVersion,"Sec-WebSocket-Key":_}},q&&(s.headers.Authorization="Basic "+new Buffer(q).toString("base64")),i.value.protocol&&(s.headers["Sec-WebSocket-Protocol"]=i.value.protocol),i.value.host&&(s.headers.Host=i.value.host),i.value.headers)for(E in i.value.headers)i.value.headers.hasOwnProperty(E)&&(s.headers[E]=i.value.headers[E]);if(i.isDefinedAndNonNull("pfx")||i.isDefinedAndNonNull("key")||i.isDefinedAndNonNull("passphrase")||i.isDefinedAndNonNull("cert")||i.isDefinedAndNonNull("ca")||i.isDefinedAndNonNull("ciphers")||i.isDefinedAndNonNull("rejectUnauthorized")){if(t)throw Error("Client side certificates are not supported on Node 0.4.x");i.isDefinedAndNonNull("pfx")&&(s.pfx=i.value.pfx),i.isDefinedAndNonNull("key")&&(s.key=i.value.key),i.isDefinedAndNonNull("passphrase")&&(s.passphrase=i.value.passphrase),i.isDefinedAndNonNull("cert")&&(s.cert=i.value.cert),i.isDefinedAndNonNull("ca")&&(s.ca=i.value.ca),i.isDefinedAndNonNull("ciphers")&&(s.ciphers=i.value.ciphers),i.isDefinedAndNonNull("rejectUnauthorized")&&(s.rejectUnauthorized=i.value.rejectUnauthorized),h||(h=new k.Agent(s))}t?s.path=(f.pathname||"/")+(f.search||""):s.path=f.path||"/",h&&(s.agent=h),S&&(s.socketPath=f.pathname),i.value.origin&&(i.value.protocolVersion<13?s.headers["Sec-WebSocket-Origin"]=i.value.origin:s.headers.Origin=i.value.origin),d=this,v=k.request(s),(t?h:v).on("error",function(e){d.emit("error",e),r.call(this,e)}),(t?h:v).once("response",function(t){var e=Error("unexpected server response ("+t.statusCode+")");d.emit("error",e),r.call(this,e)}),(t?h:v).once("upgrade",function(p,a,g){var l,r,f,s;return d.readyState==e.CLOSED?(d.emit("close"),n(d),void a.end()):(l=p.headers["sec-websocket-accept"],void 0===l||l!==O?(d.emit("error","invalid server key"),n(d),void a.end()):(r=p.headers["sec-websocket-protocol"],f=(i.value.protocol||"").split(/, */),s=null,!i.value.protocol&&r?s="server sent a subprotocol even though none requested":i.value.protocol&&!r?s="server sent no subprotocol even though requested":r&&-1===f.indexOf(r)&&(s="server responded with an invalid protocol"),s?(d.emit("error",s),n(d),void a.end()):(r&&(d.protocol=r),o.call(d,u,c,a,g),n(t?h:v),v=null,void(h=null))))}),v.end(),this.readyState=e.CONNECTING}function o(a,c,n,o){function s(r){if(t.readyState==e.OPEN){if(o&&o.length>0){t.bytesReceived+=o.length;var n=o;o=null,t._receiver.add(n)}i=u,r&&(t.bytesReceived+=r.length,t._receiver.add(r))}}function u(e){e&&(t.bytesReceived+=e.length),t._receiver.add(e)}var t,i;this._socket=n,n.setTimeout(0),n.setNoDelay(!0),t=this,this._receiver=new a,n.on("end",r.bind(this)),n.on("close",r.bind(this)),n.on("error",r.bind(this)),i=s,process.nextTick(s),t._receiver.ontext=function(r,e){e=e||{},t.emit("message",r,e)},t._receiver.onbinary=function(r,e){e=e||{},e.binary=!0,t.emit("message",r,e)},t._receiver.onping=function(r,e){e=e||{},t.pong(r,{mask:!t._isServer,binary:e.binary===!0},!0),t.emit("ping",r,e)},t._receiver.onpong=function(e,r){t.emit("pong",e,r)},t._receiver.onclose=function(r,n,e){e=e||{},t.close(r,n)},t._receiver.onerror=function(r,e){t.close(void 0!==e?e:1002,""),t.emit("error",r,e)},this._sender=new c(n),this._sender.on("error",function(e){t.close(1002,""),t.emit("error",e)}),this.readyState=e.OPEN,this.emit("open"),n.on("data",i)}function i(e){e._queue=e._queue||[]}function s(r){var e,n,t=r._queue;if(void 0!==t)for(delete r._queue,e=0,n=t.length;n>e;++e)t[e]()}function x(t,o,n,r){o.on("data",function(o){return t.readyState!=e.OPEN?void("function"==typeof r?r(Error("not opened")):(delete t._queue,t.emit("error",Error("not opened")))):(n.fin=!1,void t._sender.send(o,n))}),o.on("end",function(){return t.readyState!=e.OPEN?void("function"==typeof r?r(Error("not opened")):(delete t._queue,t.emit("error",Error("not opened")))):(n.fin=!0,t._sender.send(null,n),void("function"==typeof r&&r(null)))})}function r(o){var t,r;if(this.readyState!=e.CLOSED){if(t=this.readyState!=e.CONNECTING,this.readyState=e.CLOSED,clearTimeout(this._closeTimer),this._closeTimer=null,t&&this.emit("close",this._closeCode||1e3,this._closeMessage||""),this._socket){n(this._socket),r=this._socket,this._socket.on("error",function(){try{r.destroy()}catch(e){}});try{o?this._socket.destroy():this._socket.end()}catch(i){}this._socket=null}this._sender&&(n(this._sender),this._sender=null),this._receiver&&(this._receiver.cleanup(),this._receiver=null),n(this),this.on("error",function(){}),delete this._queue}}function n(e){t?e._events={}:e.removeAllListeners()}var f=require("util"),S=require("events"),p=require("http"),g=require("https"),y=require("crypto"),m=require("url"),v=require("fs"),a=require("options"),c=require("./Sender"),u=require("./Receiver"),k=require("./Sender.hixie"),E=require("./Receiver.hixie"),l=13,q=3e4,t=/^v0\.4/.test(process.version);f.inherits(e,S.EventEmitter),["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(t,r){e.prototype[t]=e[t]=r}),e.prototype.close=function(t,r){if(this.readyState!=e.CLOSING&&this.readyState!=e.CLOSED){if(this.readyState==e.CONNECTING)return void(this.readyState=e.CLOSED);try{this.readyState=e.CLOSING,this._closeCode=t,this._closeMessage=r;var n=!this._isServer;this._sender.close(t,r,n)}catch(o){this.emit("error",o)}finally{this.terminate()}}},e.prototype.pause=function(){if(this.readyState!=e.OPEN)throw Error("not opened");return this._socket.pause()},e.prototype.ping=function(r,t,n){if(this.readyState!=e.OPEN){if(n===!0)return;throw Error("not opened")}t=t||{},void 0===t.mask&&(t.mask=!this._isServer),this._sender.ping(r,t)},e.prototype.pong=function(r,t,n){if(this.readyState!=e.OPEN){if(n===!0)return;throw Error("not opened")}t=t||{},void 0===t.mask&&(t.mask=!this._isServer),this._sender.pong(r,t)},e.prototype.resume=function(){if(this.readyState!=e.OPEN)throw Error("not opened");return this._socket.resume()},e.prototype.send=function(t,r,n){var o;if("function"==typeof r&&(n=r,r={}),this.readyState!=e.OPEN){if("function"!=typeof n)throw Error("not opened");return void n(Error("not opened"))}return t||(t=""),this._queue?(o=this,void this._queue.push(function(){o.send(t,r,n)})):(r=r||{},r.fin=!0,void 0===r.binary&&(r.binary=t instanceof ArrayBuffer||t instanceof Buffer||t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Float32Array||t instanceof Float64Array),void 0===r.mask&&(r.mask=!this._isServer),void(t instanceof v.ReadStream?(i(this),o=this,x(this,t,r,function(e){process.nextTick(function(){s(o)}),"function"==typeof n&&n(e)})):this._sender.send(t,r,n)))},e.prototype.stream=function(t,r){var n,o;if("function"==typeof t&&(r=t,t={}),n=this,"function"!=typeof r)throw Error("callback must be provided");if(this.readyState!=e.OPEN){if("function"!=typeof r)throw Error("not opened");return void r(Error("not opened"))}return this._queue?void this._queue.push(function(){n.stream(t,r)}):(t=t||{},void 0===t.mask&&(t.mask=!this._isServer),i(this),o=function(c,i){try{if(n.readyState!=e.OPEN)throw Error("not opened");t.fin=i===!0,n._sender.send(c,t),i?s(n):process.nextTick(r.bind(null,null,o))}catch(a){"function"==typeof r?r(a):(delete n._queue,n.emit("error",a))}},void process.nextTick(r.bind(null,null,o)))},e.prototype.terminate=function(){if(this.readyState!=e.CLOSED)if(this._socket){try{this._socket.end()}catch(t){return void r.call(this,!0)}this._closeTimer=setTimeout(r.bind(this,!0),q)}else this.readyState==e.CONNECTING&&r.call(this,!0)},Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){var e=0;return this._socket&&(e=this._socket.bufferSize||0),e}}),["open","error","close","message"].forEach(function(t){Object.defineProperty(e.prototype,"on"+t,{get:function(){var e=this.listeners(t)[0];return e?e._listener?e._listener:e:void 0},set:function(e){this.removeAllListeners(t),this.addEventListener(t,e)}})}),e.prototype.addEventListener=function(t,e){function n(t,n){e.call(this,new h(t,n.binary?"Binary":"Text",r))}function o(t,n){e.call(this,new w(t,n,r))}function i(t){t.target=r,e.call(this,t)}function s(){e.call(this,new d(r))}var r=this;"function"==typeof e&&("message"===t?(n._listener=e,this.on(t,n)):"close"===t?(o._listener=e,this.on(t,o)):"error"===t?(i._listener=e,this.on(t,i)):"open"===t?(s._listener=e,this.on(t,s)):this.on(t,e))},module.exports=e;