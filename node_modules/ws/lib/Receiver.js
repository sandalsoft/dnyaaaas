function t(){var e,t=-1;this.fragmentedBufferPool=new s(1024,function(e,t){return e.used+t},function(e){return t=t>=0?(t+e.used)/2:e.used}),e=-1,this.unfragmentedBufferPool=new s(1024,function(e,t){return e.used+t},function(t){return e=e>=0?(e+t.used)/2:t.used}),this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0,fragmentedOperation:!1},this.overflow=[],this.headerBuffer=new Buffer(10),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.currentMessage=[],this.expectHeader(2,this.processPacket),this.dead=!1,this.onerror=function(){},this.ontext=function(){},this.onbinary=function(){},this.onclose=function(){},this.onping=function(){},this.onpong=function(){}}function o(e){return(this[e]<<8)+this[e+1]}function r(e){return(this[e]<<24)+(this[e+1]<<16)+(this[e+2]<<8)+this[e+3]}function n(n,e,t,r){switch(n){default:e.copy(t,r,0,n);break;case 16:t[r+15]=e[15];case 15:t[r+14]=e[14];case 14:t[r+13]=e[13];case 13:t[r+12]=e[12];case 12:t[r+11]=e[11];case 11:t[r+10]=e[10];case 10:t[r+9]=e[9];case 9:t[r+8]=e[8];case 8:t[r+7]=e[7];case 7:t[r+6]=e[6];case 6:t[r+5]=e[5];case 5:t[r+4]=e[4];case 4:t[r+3]=e[3];case 3:t[r+2]=e[2];case 2:t[r+1]=e[1];case 1:t[r]=e[0]}}var e,l=require("util"),i=require("./Validation").Validation,u=require("./ErrorCodes"),s=require("./BufferPool"),a=require("./BufferUtil").BufferUtil,c=/^v0\.4/.test(process.version);module.exports=t,t.prototype.add=function(t){var e,o,r=t.length;if(0!=r){if(null==this.expectBuffer)return void this.overflow.push(t);for(e=Math.min(r,this.expectBuffer.length-this.expectOffset),n(e,t,this.expectBuffer,this.expectOffset),this.expectOffset+=e,r>e&&this.overflow.push(t.slice(e));this.expectBuffer&&this.expectOffset==this.expectBuffer.length;)o=this.expectBuffer,this.expectBuffer=null,this.expectOffset=0,this.expectHandler.call(this,o)}},t.prototype.cleanup=function(){this.dead=!0,this.overflow=null,this.headerBuffer=null,this.expectBuffer=null,this.expectHandler=null,this.unfragmentedBufferPool=null,this.fragmentedBufferPool=null,this.state=null,this.currentMessage=null,this.onerror=null,this.ontext=null,this.onbinary=null,this.onclose=null,this.onping=null,this.onpong=null},t.prototype.expectHeader=function(o,i){var e,t,r;if(0==o)return void i(null);for(this.expectBuffer=this.headerBuffer.slice(this.expectOffset,this.expectOffset+o),this.expectHandler=i,e=o;e>0&&this.overflow.length>0;)t=this.overflow.pop(),e<t.length&&this.overflow.push(t.slice(e)),r=Math.min(t.length,e),n(r,t,this.expectBuffer,this.expectOffset),this.expectOffset+=r,e-=r},t.prototype.expectData=function(o,i){var e,t,r;if(0==o)return void i(null);for(this.expectBuffer=this.allocateFromPool(o,this.state.fragmentedOperation),this.expectHandler=i,e=o;e>0&&this.overflow.length>0;)t=this.overflow.pop(),e<t.length&&this.overflow.push(t.slice(e)),r=Math.min(t.length,e),n(r,t,this.expectBuffer,this.expectOffset),this.expectOffset+=r,e-=r},t.prototype.allocateFromPool=c?function(e){return new Buffer(e)}:function(e,t){return(t?this.fragmentedBufferPool:this.unfragmentedBufferPool).get(e)},t.prototype.processPacket=function(t){var r,n;if(0!=(112&t[0]))return void this.error("reserved fields must be empty",1002);if(this.state.lastFragment=128==(128&t[0]),this.state.masked=128==(128&t[1]),r=15&t[0],0===r){if(this.state.fragmentedOperation=!0,this.state.opcode=this.state.activeFragmentedOperation,1!=this.state.opcode&&2!=this.state.opcode)return void this.error("continuation frame cannot follow current opcode",1002)}else{if(3>r&&null!=this.state.activeFragmentedOperation)return void this.error("data frames after the initial data frame must have opcode 0",1002);this.state.opcode=r,this.state.lastFragment===!1?(this.state.fragmentedOperation=!0,this.state.activeFragmentedOperation=r):this.state.fragmentedOperation=!1}n=e[this.state.opcode],void 0===n?this.error("no handler for opcode "+this.state.opcode,1002):n.start.call(this,t)},t.prototype.endPacket=function(){this.state.fragmentedOperation?this.state.lastFragment&&this.fragmentedBufferPool.reset(!1):this.unfragmentedBufferPool.reset(!0),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.state.lastFragment&&this.state.opcode===this.state.activeFragmentedOperation&&(this.state.activeFragmentedOperation=null),this.state.lastFragment=!1,this.state.opcode=null!=this.state.activeFragmentedOperation?this.state.activeFragmentedOperation:0,this.state.masked=!1,this.expectHeader(2,this.processPacket)},t.prototype.reset=function(){this.dead||(this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0,fragmentedOperation:!1},this.fragmentedBufferPool.reset(!0),this.unfragmentedBufferPool.reset(!0),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.overflow=[],this.currentMessage=[])},t.prototype.unmask=function(t,e,r){return null!=t&&null!=e&&a.unmask(e,t),r?e:null!=e?e.toString("utf8"):""},t.prototype.concatBuffers=function(t){var e,n,r,o=0;for(e=0,n=t.length;n>e;++e)o+=t[e].length;return r=new Buffer(o),a.merge(r,t),r},t.prototype.error=function(e,t){return this.reset(),this.onerror(e,t),this},e={1:{start:function(i){var t=this,n=127&i[1];126>n?e[1].getData.call(t,n):126==n?t.expectHeader(2,function(r){e[1].getData.call(t,o.call(r,0))}):127==n&&t.expectHeader(8,function(n){return 0!=r.call(n,0)?void t.error("packets with length spanning more than 32 bit is currently not supported",1008):void e[1].getData.call(t,r.call(n,4))})},getData:function(r){var t=this;t.state.masked?t.expectHeader(4,function(n){var o=n;t.expectData(r,function(r){e[1].finish.call(t,o,r)})}):t.expectData(r,function(r){e[1].finish.call(t,null,r)})},finish:function(r,n){var e,t=this.unmask(r,n,!0);if(null!=t&&this.currentMessage.push(t),this.state.lastFragment){if(e=this.concatBuffers(this.currentMessage),!i.isValidUTF8(e))return void this.error("invalid utf8 sequence",1007);this.ontext(e.toString("utf8"),{masked:this.state.masked,buffer:e}),this.currentMessage=[]}this.endPacket()}},2:{start:function(i){var t=this,n=127&i[1];126>n?e[2].getData.call(t,n):126==n?t.expectHeader(2,function(r){e[2].getData.call(t,o.call(r,0))}):127==n&&t.expectHeader(8,function(n){return 0!=r.call(n,0)?void t.error("packets with length spanning more than 32 bit is currently not supported",1008):void e[2].getData.call(t,r.call(n,4,!0))})},getData:function(r){var t=this;t.state.masked?t.expectHeader(4,function(n){var o=n;t.expectData(r,function(r){e[2].finish.call(t,o,r)})}):t.expectData(r,function(r){e[2].finish.call(t,null,r)})},finish:function(r,n){var e,t=this.unmask(r,n,!0);null!=t&&this.currentMessage.push(t),this.state.lastFragment&&(e=this.concatBuffers(this.currentMessage),this.onbinary(e,{masked:this.state.masked,buffer:e}),this.currentMessage=[]),this.endPacket()}},8:{start:function(n){var r,t=this;return 0==t.state.lastFragment?void t.error("fragmented close is not supported",1002):(r=127&n[1],void(126>r?e[8].getData.call(t,r):t.error("control frames cannot have more than 125 bytes of data",1002)))},getData:function(r){var t=this;t.state.masked?t.expectHeader(4,function(n){var o=n;t.expectData(r,function(r){e[8].finish.call(t,o,r)})}):t.expectData(r,function(r){e[8].finish.call(t,null,r)})},finish:function(a,e){var r,n,s,t=this;if(e=t.unmask(a,e,!0),e&&1==e.length)return void t.error("close packets with data must be at least two bytes long",1002);if(r=e&&e.length>1?o.call(e,0):1e3,!u.isValidErrorCode(r))return void t.error("invalid error code",1002);if(n="",e&&e.length>2){if(s=e.slice(2),!i.isValidUTF8(s))return void t.error("invalid utf8 sequence",1007);n=s.toString("utf8")}this.onclose(r,n,{masked:t.state.masked}),this.reset()}},9:{start:function(n){var r,t=this;return 0==t.state.lastFragment?void t.error("fragmented ping is not supported",1002):(r=127&n[1],void(126>r?e[9].getData.call(t,r):t.error("control frames cannot have more than 125 bytes of data",1002)))},getData:function(r){var t=this;t.state.masked?t.expectHeader(4,function(n){var o=n;t.expectData(r,function(r){e[9].finish.call(t,o,r)})}):t.expectData(r,function(r){e[9].finish.call(t,null,r)})},finish:function(e,t){this.onping(this.unmask(e,t,!0),{masked:this.state.masked,binary:!0}),this.endPacket()}},10:{start:function(n){var r,t=this;return 0==t.state.lastFragment?void t.error("fragmented pong is not supported",1002):(r=127&n[1],void(126>r?e[10].getData.call(t,r):t.error("control frames cannot have more than 125 bytes of data",1002)))},getData:function(r){var t=this;this.state.masked?this.expectHeader(4,function(n){var o=n;t.expectData(r,function(r){e[10].finish.call(t,o,r)})}):this.expectData(r,function(r){e[10].finish.call(t,null,r)})},finish:function(e,t){this.onpong(this.unmask(e,t,!0),{masked:this.state.masked,binary:!0}),this.endPacket()}}};