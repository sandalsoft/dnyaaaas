function t(e,r){if(e=new u({host:"0.0.0.0",port:null,server:null,verifyClient:null,handleProtocols:null,path:null,noServer:!1,disableHixie:!1,clientTracking:!0}).merge(e),!e.isDefinedAndNonNull("port")&&!e.isDefinedAndNonNull("server")&&!e.value.noServer)throw new TypeError("`port` or a `server` must be provided");var t=this;if(e.isDefinedAndNonNull("port"))this._server=l.createServer(function(t,e){e.writeHead(200,{"Content-Type":"text/plain"}),e.end("Not implemented")}),this._server.listen(e.value.port,e.value.host,r),this._closeServer=function(){t._server.close()};else if(e.value.server&&(this._server=e.value.server,e.value.path)){if(this._server._webSocketPaths&&e.value.server._webSocketPaths[e.value.path])throw Error("two instances of WebSocketServer cannot listen on the same http server path");"object"!=typeof this._server._webSocketPaths&&(this._server._webSocketPaths={}),this._server._webSocketPaths[e.value.path]=1}this._server&&this._server.once("listening",function(){t.emit("listening")}),void 0!==this._server&&(this._server.on("error",function(e){t.emit("error",e)}),this._server.on("upgrade",function(e,o,r){var n=new Buffer(r.length);r.copy(n),t.handleUpgrade(e,o,n,function(r){t.emit("connection"+e.url,r),t.emit("connection",r)})})),this.options=e.value,this.path=e.value.path,this.clients=[]}function s(o,t,d,h){var s,a,f,i,c,l,u,p=function(){try{t.destroy()}catch(e){}};if(t.on("error",p),!o.headers["sec-websocket-key"])return void e(t,400,"Bad Request");if(s=parseInt(o.headers["sec-websocket-version"]),-1===[8,13].indexOf(s))return void e(t,400,"Bad Request");if(a=o.headers["sec-websocket-protocol"],f=13>s?o.headers["sec-websocket-origin"]:o.headers.origin,i=this,c=function(c){var a,e,u=o.headers["sec-websocket-key"],l=r.createHash("sha1");l.update(u+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),u=l.digest("base64"),a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+u],void 0!==c&&a.push("Sec-WebSocket-Protocol: "+c),i.emit("headers",a),t.setTimeout(0),t.setNoDelay(!0);try{t.write(a.concat("","").join("\r\n"))}catch(f){try{t.destroy()}catch(f){}return}e=new n([o,t,d],{protocolVersion:s,protocol:c}),i.options.clientTracking&&(i.clients.push(e),e.on("close",function(){var t=i.clients.indexOf(e);-1!=t&&i.clients.splice(t,1)})),t.removeListener("error",p),h(e)},l=function(){var n,r,o;return"function"==typeof i.options.handleProtocols?(n=(a||"").split(/, */),r=!1,o=i.options.handleProtocols(n,function(n,o){r=!0,n?c(o):e(t,404,"Unauthorized")}),void(r||e(t,501,"Could not process protocols"))):void(void 0!==a?c(a.split(/, */)[0]):c())},"function"==typeof this.options.verifyClient){if(u={origin:f,secure:void 0!==o.connection.authorized||void 0!==o.connection.encrypted,req:o},2==this.options.verifyClient.length)return void this.options.verifyClient(u,function(r){r?l():e(t,401,"Unauthorized")});if(!this.options.verifyClient(u))return void e(t,401,"Unauthorized")}l()}function a(o,t,s,p){var a,i,c,u,l=function(){try{t.destroy()}catch(e){}};if(t.on("error",l),this.options.disableHixie)return void e(t,401,"Hixie support disabled");if(!o.headers["sec-websocket-key2"])return void e(t,400,"Bad Request");if(a=o.headers.origin,i=this,c=function(){var y,v,d,g,c,u,f,h,m;y=o.headers["x-forwarded-host"]?o.headers["x-forwarded-host"]:o.headers.host,v=("https"===o.headers["x-forwarded-proto"]||t.encrypted?"wss":"ws")+"://"+y+o.url,d=o.headers["sec-websocket-protocol"],g=function(g,m){var s,c,f,u,y=o.headers["sec-websocket-key1"],b=o.headers["sec-websocket-key2"],h=r.createHash("md5");[y,b].forEach(function(o){var r=parseInt(o.replace(/[^\d]/g,"")),n=o.replace(/[^ ]/g,"").length;return 0===n||r%n!==0?void e(t,400,"Bad Request"):(r/=n,void h.update(String.fromCharCode(r>>24&255,r>>16&255,r>>8&255,255&r)))}),h.update(g.toString("binary")),s=["HTTP/1.1 101 Switching Protocols","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Location: "+v],void 0!==d&&s.push("Sec-WebSocket-Protocol: "+d),void 0!==a&&s.push("Sec-WebSocket-Origin: "+a),t.setTimeout(0),t.setNoDelay(!0);try{c=new Buffer(s.concat("","").join("\r\n")),f=new Buffer(h.digest("binary"),"binary"),u=new Buffer(c.length+f.length),c.copy(u,0),f.copy(u,c.length),t.write(u,"binary",function(r){if(!r){var e=new n([o,t,m],{protocolVersion:"hixie-76",protocol:d});i.options.clientTracking&&(i.clients.push(e),e.on("close",function(){var t=i.clients.indexOf(e);-1!=t&&i.clients.splice(t,1)})),t.removeListener("error",l),p(e)}})}catch(x){try{t.destroy()}catch(x){}return}},c=8,s&&s.length>=c?(u=s.slice(0,c),f=s.length>c?s.slice(c):null,g.call(i,u,f)):(u=new Buffer(c),s.copy(u,0),h=s.length,f=null,m=function(r){var e=Math.min(r.length,c-h);0!==e&&(r.copy(u,h,0,e),h+=e,h==c&&(t.removeListener("data",m),e<r.length&&(f=r.slice(e)),g.call(i,u,f)))},t.on("data",m))},"function"==typeof this.options.verifyClient){if(u={origin:a,secure:void 0!==o.connection.authorized||void 0!==o.connection.encrypted,req:o},2==this.options.verifyClient.length)return i=this,void this.options.verifyClient(u,function(r){r?c.apply(i):e(t,401,"Unauthorized")});if(!this.options.verifyClient(u))return void e(t,401,"Unauthorized")}c()}function e(e,t,r){try{var n=["HTTP/1.1 "+t+" "+r,"Content-type: text/html"];e.write(n.concat("","").join("\r\n"))}catch(o){}finally{try{e.destroy()}catch(o){}}}var o=require("util"),i=require("events"),l=require("http"),r=require("crypto"),c=require("url"),u=require("options"),n=require("./WebSocket"),p=require("tls"),c=require("url");o.inherits(t,i.EventEmitter),t.prototype.close=function(){var e,r,t=null;try{for(e=0,r=this.clients.length;r>e;++e)this.clients[e].terminate()}catch(n){t=n}this.path&&this._server._webSocketPaths&&(delete this._server._webSocketPaths[this.path],0==Object.keys(this._server._webSocketPaths).length&&delete this._server._webSocketPaths);try{void 0!==this._closeServer&&this._closeServer()}finally{delete this._server}if(t)throw t},t.prototype.handleUpgrade=function(t,n){if(this.options.path){var r=c.parse(t.url);if(r&&r.pathname!==this.options.path)return}return void 0===t.headers.upgrade||"websocket"!==t.headers.upgrade.toLowerCase()?void e(n,400,"Bad Request"):void(t.headers["sec-websocket-key1"]?a.apply(this,arguments):s.apply(this,arguments))},module.exports=t;