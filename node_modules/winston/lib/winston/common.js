var r=require("util"),t=require("crypto"),n=require("cycle"),o=require("fs"),e=require("./config");exports.setLevels=function(r,t,n){return t&&Object.keys(t).forEach(function(e){delete r[e]}),r.levels=n||e.npm.levels,r.padLevels&&(r.levelLength=exports.longestElement(Object.keys(r.levels))),Object.keys(r.levels).forEach(function(e){r[e]=function(){var t=[e].concat(Array.prototype.slice.call(arguments));r.log.apply(r,t)}}),r},exports.longestElement=function(e){return Math.max.apply(null,e.map(function(e){return e.length}))},exports.clone=function(e){var t,r;if(!(e instanceof Object))return e;if(e instanceof Date)return e;t={};for(r in e)Array.isArray(e[r])?t[r]=e[r].slice(0):e[r]instanceof Buffer?t[r]=e[r].slice(0):"function"!=typeof e[r]?t[r]=e[r]instanceof Object?exports.clone(e[r]):e[r]:"function"==typeof e[r]&&(t[r]=e[r]);return t},exports.log=function(o){var t,a,c="function"==typeof o.timestamp?o.timestamp:exports.timestamp,s=o.timestamp?c():null,i=void 0!==o.meta||null!==o.meta?exports.clone(n.decycle(o.meta)):null;return o.raw?("object"!=typeof i&&null!=i&&(i={meta:i}),t=exports.clone(i)||{},t.level=o.level,t.message=o.message.stripColors,JSON.stringify(t)):o.json?("object"!=typeof i&&null!=i&&(i={meta:i}),t=exports.clone(i)||{},t.level=o.level,t.message=o.message,s&&(t.timestamp=s),o.logstash===!0&&(a={},void 0!==t.message&&(a["@message"]=t.message,delete t.message),void 0!==t.timestamp&&(a["@timestamp"]=t.timestamp,delete t.timestamp),a["@fields"]=exports.clone(t),t=a),"function"==typeof o.stringify?o.stringify(t):JSON.stringify(t,function(r,e){return e instanceof Buffer?e.toString("base64"):e})):(t=s?s+" - ":"",t+=o.colorize?e.colorize(o.level):o.level,t+=": ",t+=o.label?"["+o.label+"] ":"",t+=o.message,null!==i&&void 0!==i&&(i&&i instanceof Error&&i.stack&&(i=i.stack),"object"!=typeof i?t+=" "+i:Object.keys(i).length>0&&(t+=" "+(o.prettyPrint?"\n"+r.inspect(i,!1,null,o.colorize):exports.serialize(i)))),t)},exports.capitalize=function(e){return e&&e[0].toUpperCase()+e.slice(1)},exports.hash=function(e){return t.createHash("sha1").update(e).digest("hex")},exports.pad=function(e){return 10>e?"0"+e.toString(10):e.toString(10)},exports.timestamp=function(){return(new Date).toISOString()},exports.serialize=function(e,i){var n,t,a,r,o,s;if(null===e?e="null":void 0===e?e="undefined":e===!1&&(e="false"),"object"!=typeof e)return i?i+"="+e:e;if(e instanceof Buffer)return i?i+"="+e.toString("base64"):e.toString("base64");for(n="",t=Object.keys(e),a=t.length,r=0;a>r;r++){if(Array.isArray(e[t[r]])){for(n+=t[r]+"=[",o=0,s=e[t[r]].length;s>o;o++)n+=exports.serialize(e[t[r]][o]),s-1>o&&(n+=", ");n+="]"}else n+=e[t[r]]instanceof Date?t[r]+"="+e[t[r]]:exports.serialize(e[t[r]],t[r]);a-1>r&&(n+=", ")}return n},exports.tailFile=function(r,i){function s(){setTimeout(function(){e.resume()},1e3)}var n,e=o.createReadStream(r.file,{encoding:"utf8"}),t="",a=0;return n=e.destroy.bind(e),e.destroy=function(){},-1===r.start&&delete r.start,e.on("data",function(e){for(var e=(t+e).split(/\n+/),o=e.length-1,n=0;o>n;n++)(null==r.start||a>r.start)&&i(null,e[n]),a++;t=e[o]}),e.on("error",function(e){i(e),n()}),e.on("end",function(){t&&(e.emit("line",t),t=""),s()}),n};