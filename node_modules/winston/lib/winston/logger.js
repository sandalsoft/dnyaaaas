var n,o=require("events"),i=require("util"),r=require("async"),t=require("./config"),a=require("./common"),s=require("./exception"),c=require("stream").Stream,u=1e4,e=exports.Logger=function(e){o.EventEmitter.call(this),e=e||{};var r=this,n=!1;this.padLevels=e.padLevels||!1,this.setLevels(e.levels),e.colors&&t.addColors(e.colors),this.level=e.level||"info",this.emitErrs=e.emitErrs||!1,this.stripColors=e.stripColors||!1,this.exitOnError=void 0!==e.exitOnError?e.exitOnError:!0,this.transports={},this.rewriters=[],this.exceptionHandlers={},this.profilers={},this._names=[],this._hnames=[],e.transports&&e.transports.forEach(function(e){r.add(e,null,!0),e.handleExceptions&&(n=!0)}),e.rewriters&&e.rewriters.forEach(function(e){r.addRewriter(e)}),e.exceptionHandlers&&(n=!0,e.exceptionHandlers.forEach(function(e){r._hnames.push(e.name),r.exceptionHandlers[e.name]=e})),(e.handleExceptions||n)&&this.handleExceptions()};i.inherits(e,o.EventEmitter),e.prototype.extend=function(t){var e=this;return["log","profile","startTimer"].concat(Object.keys(this.levels)).forEach(function(r){t[r]=function(){return e[r].apply(e,arguments)}}),this},e.prototype.log=function(t){function c(t){a?a(t):e.emitErrs&&e.emit("error",t)}function p(i,o){var r=e.transports[i];r.level&&e.levels[r.level]<=e.levels[t]||!r.level&&e.levels[e.level]<=e.levels[t]?r.log(t,n,s,function(i){return i?(i.transport=r,u(i),o()):(e.emit("logging",r,t,n,s),void o())}):o()}function u(r){if(a){if(r)return a(r);a(null,t,n,s)}a=null,r||e.emit("logged",t,n,s)}for(var a,s,n,l,e=this,o=Array.prototype.slice.call(arguments,1);null===o[o.length-1];)o.pop();return a="function"==typeof o[o.length-1]?o.pop():null,s="object"==typeof o[o.length-1]?o.pop():{},n=i.format.apply(null,o),this.padLevels&&(n=Array(this.levelLength-t.length+1).join(" ")+n),0===this.transports.length?c(Error("Cannot log with no transports.")):void 0===e.levels[t]?c(Error("Unknown log level: "+t)):(this.rewriters.forEach(function(e){s=e(t,n,s)}),this.stripColors&&(l=/\u001b\[(\d+(;\d+)*)?m/g,n=(""+n).replace(l,"")),r.forEach(this._names,p,u),this)},e.prototype.query=function(e,t){function n(t,r){e.query&&(e.query=t.formatQuery(u)),t.query(e,function(n,o){return n?r(n):void r(null,t.formatResults(o,e.format))})}function s(e,t){n(e,function(n,r){r=n||r,r&&(i[e.name]=r),t()})}"function"==typeof e&&(t=e,e={});var o,c=this,e=e||{},i={},u=a.clone(e.query)||{};return e.transport?(e.transport=e.transport.toLowerCase(),n(this.transports[e.transport],t)):(o=this._names.map(function(e){return c.transports[e]}).filter(function(e){return!!e.query}),void r.forEach(o,s,function(){t(null,i)}))},e.prototype.stream=function(e){var t,r,o,n,i=this;return e=e||{},t=new c,r=[],e.transport&&(n=this.transports[e.transport],delete e.transport,n&&n.stream)?n.stream(e):(t._streams=r,t.destroy=function(){for(var e=r.length;e--;)r[e].destroy()},o=this._names.map(function(e){return i.transports[e]}).filter(function(e){return!!e.stream}),o.forEach(function(o){var n=o.stream(e);n&&(r.push(n),n.on("log",function(e){e.transport=e.transport||[],e.transport.push(o.name),t.emit("log",e)}),n.on("error",function(e){e.transport=e.transport||[],e.transport.push(o.name),t.emit("error",e)}))}),t)},e.prototype.close=function(){var e=this;this._names.forEach(function(r){var t=e.transports[r];t&&t.close&&t.close()})},e.prototype.handleExceptions=function(){var r=Array.prototype.slice.call(arguments),e=[],t=this;r.forEach(function(t){Array.isArray(t)?e=e.concat(t):e.push(t)}),e.forEach(function(e){t.exceptionHandlers[e.name]=e}),this._hnames=Object.keys(t.exceptionHandlers),this.catchExceptions||(this.catchExceptions=this._uncaughtException.bind(this),process.on("uncaughtException",this.catchExceptions))},e.prototype.unhandleExceptions=function(){var e=this;this.catchExceptions&&(Object.keys(this.exceptionHandlers).forEach(function(r){var t=e.exceptionHandlers[r];t.close&&t.close()}),this.exceptionHandlers={},Object.keys(this.transports).forEach(function(r){var t=e.transports[r];t.handleExceptions&&(t.handleExceptions=!1)}),process.removeListener("uncaughtException",this.catchExceptions),this.catchExceptions=!1)},e.prototype.add=function(t,r,n){var e=n?t:new t(r);if(!e.name&&!e.log)throw Error("Unknown transport with no log() method");if(this.transports[e.name])throw Error("Transport already attached: "+e.name);return this.transports[e.name]=e,this._names=Object.keys(this.transports),e._onError=this._onError.bind(this,e),e.on("error",e._onError),e.handleExceptions&&!this.catchExceptions&&this.handleExceptions(),this},e.prototype.addRewriter=function(e){this.rewriters.push(e)},e.prototype.clear=function(){for(var e in this.transports)this.remove({name:e})},e.prototype.remove=function(r){var e,t=r.name||r.prototype.name;if(!this.transports[t])throw Error("Transport "+t+" not attached to this instance");return e=this.transports[t],delete this.transports[t],this._names=Object.keys(this.transports),e.close&&e.close(),e.removeListener("error",e._onError),this},n=function(e){this.logger=e,this.start=Date.now(),this.done=function(n){var e,r,t;return e=Array.prototype.slice.call(arguments),r="function"==typeof e[e.length-1]?e.pop():null,t="object"==typeof e[e.length-1]?e.pop():{},t.duration=Date.now()-this.start+"ms",this.logger.info(n,t,r)}},e.prototype.startTimer=function(){return new n(this)},e.prototype.profile=function(t){var n,e,o,r,i,a=Date.now();return this.profilers[t]?(n=this.profilers[t],delete this.profilers[t],e=Array.prototype.slice.call(arguments),i="function"==typeof e[e.length-1]?e.pop():null,r="object"==typeof e[e.length-1]?e.pop():{},o=2===e.length?e[1]:t,r.duration=a-n+"ms",this.info(o,r,i)):(this.profilers[t]=a,this)},e.prototype.setLevels=function(e){return a.setLevels(this,this.levels,e)},e.prototype.cli=function(){return this.padLevels=!0,this.setLevels(t.cli.levels),t.addColors(t.cli.colors),this.transports.console&&(this.transports.console.colorize=!0,this.transports.console.timestamp=!1),this},e.prototype._uncaughtException=function(e){function c(t,r){t.logException("uncaughtException: "+e.message,u,r,e)}function t(){n&&!a&&(clearTimeout(i),a=!0,process.exit(1))}var i,n,a=!1,u=s.getAllInfo(e),o=this._getExceptionHandlers();return n="function"==typeof this.exitOnError?this.exitOnError(e):this.exitOnError,o&&0!==o.length?(r.forEach(o,c,t),void(n&&(i=setTimeout(t,3e3)))):t()},e.prototype._getExceptionHandlers=function(){var e=this;return this._hnames.map(function(t){return e.exceptionHandlers[t]}).concat(this._names.map(function(t){return e.transports[t].handleExceptions&&e.transports[t]})).filter(Boolean)},e.prototype._onError=function(e,t){this.emitErrs&&this.emit("error",t,e)};