function t(f){var u,i,y,g,a,t=this,b=require("http"),x=require("https"),o={},h=!1,d={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},s=d,m=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],v=["TRACE","TRACK","CONNECT"],l=!1,p=!1,c={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null,y=function(e){return h||e&&-1===m.indexOf(e.toLowerCase())},g=function(e){return e&&-1===v.indexOf(e)},this.open=function(e,r,t,n,i){if(this.abort(),p=!1,!g(e))throw"SecurityError: Request method not allowed";o={method:e,url:""+r,async:"boolean"!=typeof t?!0:t,user:n||null,password:i||null},a(this.OPENED)},this.setDisableHeaderCheck=function(e){h=e},this.setRequestHeader=function(e,t){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(!y(e))return void console.warn('Refused to set unsafe header "'+e+'"');if(l)throw"INVALID_STATE_ERR: send flag is true";s[e]=t},this.getResponseHeader=function(e){return"string"==typeof e&&this.readyState>this.OPENED&&i.headers[e.toLowerCase()]&&!p?i.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){var t,e;if(this.readyState<this.HEADERS_RECEIVED||p)return"";t="";for(e in i.headers)"set-cookie"!==e&&"set-cookie2"!==e&&(t+=e+": "+i.headers[e]+"\r\n");return t.substr(0,t.length-2)},this.getRequestHeader=function(e){return"string"==typeof e&&s[e]?s[e]:""},this.send=function(h){function C(c){var e,n;return i=c,302===i.statusCode||303===i.statusCode||307===i.statusCode?(o.url=i.headers.location,e=r.parse(o.url),m=e.hostname,n={hostname:e.hostname,port:e.port,path:e.path,method:303===i.statusCode?"GET":o.method,headers:s},u=E(n,C).on("error",O),void u.end()):(i.setEncoding("utf8"),a(t.HEADERS_RECEIVED),t.status=i.statusCode,i.on("data",function(e){e&&(t.responseText+=e),l&&a(t.LOADING)}),i.on("end",function(){l&&(a(t.DONE),l=!1)}),void i.on("error",function(e){t.handleError(e)}))}function O(e){t.handleError(e)}var y,_,c,m,v,S,q,w,k,E,d,g,A,T,j;if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(l)throw"INVALID_STATE_ERR: send has already been called";switch(y=!1,_=!1,c=r.parse(o.url),c.protocol){case"https:":y=!0;case"http:":m=c.hostname;break;case"file:":_=!0;break;case void 0:case"":m="localhost";break;default:throw"Protocol not supported."}if(_){if("GET"!==o.method)throw"XMLHttpRequest: Only GET method is supported";if(o.async)e.readFile(c.pathname,"utf8",function(e,r){e?t.handleError(e):(t.status=200,t.responseText=r,a(t.DONE))});else try{this.responseText=e.readFileSync(c.pathname,"utf8"),this.status=200,a(t.DONE)}catch(N){this.handleError(N)}}else if(v=c.port||(y?443:80),S=c.pathname+(c.search?c.search:""),s.Host=m,y&&443===v||80===v||(s.Host+=":"+c.port),o.user&&(void 0===o.password&&(o.password=""),q=new Buffer(o.user+":"+o.password),s.Authorization="Basic "+q.toString("base64")),"GET"===o.method||"HEAD"===o.method?h=null:h?(s["Content-Length"]=Buffer.isBuffer(h)?h.length:Buffer.byteLength(h),s["Content-Type"]||(s["Content-Type"]="text/plain;charset=UTF-8")):"POST"===o.method&&(s["Content-Length"]=0),w=!1,f&&f.agent&&(w=f.agent),k={host:m,port:v,path:S,method:o.method,headers:s,agent:w},p=!1,o.async)E=y?x.request:b.request,l=!0,t.dispatchEvent("readystatechange"),u=E(k,C).on("error",O),h&&u.write(h),u.end(),t.dispatchEvent("loadstart");else{for(d=".node-xmlhttprequest-content-"+process.pid,g=".node-xmlhttprequest-sync-"+process.pid,e.writeFileSync(g,"","utf8"),A="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(y?"s":"")+".request;var options = "+JSON.stringify(k)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {  responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+d+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');fs.unlinkSync('"+g+"');});response.on('error', function(error) {fs.writeFileSync('"+d+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');fs.unlinkSync('"+g+"');});}).on('error', function(error) {fs.writeFileSync('"+d+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');fs.unlinkSync('"+g+"');});"+(h?"req.write('"+h.replace(/'/g,"\\'")+"');":"")+"req.end();",T=n(process.argv[0],["-e",A]);e.existsSync(g););t.responseText=e.readFileSync(d,"utf8"),T.stdin.end(),e.unlinkSync(d),t.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)?(j=t.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,""),t.handleError(j)):(t.status=t.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),t.responseText=t.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),a(t.DONE))}},this.handleError=function(e){this.status=503,this.statusText=e,this.responseText=e.stack,p=!0,a(this.DONE)},this.abort=function(){u&&(u.abort(),u=null),s=d,this.responseText="",this.responseXML="",p=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!l||this.readyState===this.DONE||(l=!1,a(this.DONE)),this.readyState=this.UNSENT},this.addEventListener=function(e,t){e in c||(c[e]=[]),c[e].push(t)},this.removeEventListener=function(e,t){e in c&&(c[e]=c[e].filter(function(e){return e!==t}))},this.dispatchEvent=function(e){if("function"==typeof t["on"+e]&&t["on"+e](),e in c)for(var r=0,n=c[e].length;n>r;r++)c[e][r].call(t)},a=function(e){t.readyState!==e&&(t.readyState=e,(o.async||t.readyState<t.OPENED||t.readyState===t.DONE)&&t.dispatchEvent("readystatechange"),t.readyState!==t.DONE||p||(t.dispatchEvent("load"),t.dispatchEvent("loadend")))}}var e=require("fs"),r=require("url"),n=require("child_process").spawn;module.exports=t,t.XMLHttpRequest=t;