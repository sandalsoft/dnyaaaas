var r=require("accepts"),e=require("escape-html"),t=require("fs");exports=module.exports=function(){var n=process.env.NODE_ENV||"development";return function(o,u,i,l){var p,a,s,c,f;if(o.status&&(i.statusCode=o.status),i.statusCode<400&&(i.statusCode=500),"test"!==n&&console.error(o.stack||o+""),i._header)return u.socket.destroy();if(p=r(u),a=p.types("html","json","text"),i.setHeader("X-Content-Type-Options","nosniff"),"html"===a)t.readFile(__dirname+"/public/style.css","utf8",function(r,n){return r?l(r):void t.readFile(__dirname+"/public/error.html","utf8",function(r,t){if(r)return l(r);var a=(o.stack||"").split("\n").slice(1).map(function(t){return"<li>"+e(t).replace(/  /g," &nbsp;")+"</li>"}).join("");t=t.replace("{style}",n).replace("{stack}",a).replace("{title}",e(exports.title)).replace("{statusCode}",i.statusCode).replace(/\{error\}/g,e(o+"").replace(/  /g," &nbsp;").replace(/\n/g,"<br>")),i.setHeader("Content-Type","text/html; charset=utf-8"),i.end(t)})});else if("json"===a){s={message:o.message,stack:o.stack};for(c in o)s[c]=o[c];f=JSON.stringify({error:s}),i.setHeader("Content-Type","application/json"),i.end(f)}else i.setHeader("Content-Type","text/plain"),i.end(o.stack||o+"")}},exports.title="Connect";