var t=require("util"),r=require("crypto"),n=require("cycle"),o=require("fs"),e=require("./config");exports.setLevels=function(t,r,n){return r&&Object.keys(r).forEach(function(e){delete t[e]}),t.levels=n||e.npm.levels,t.padLevels&&(t.levelLength=exports.longestElement(Object.keys(t.levels))),Object.keys(t.levels).forEach(function(e){t[e]=function(){var r=[e].concat(Array.prototype.slice.call(arguments));t.log.apply(t,r)}}),t},exports.longestElement=function(e){return Math.max.apply(null,e.map(function(e){return e.length}))},exports.clone=function(e){var r,t;if(!(e instanceof Object))return e;if(e instanceof Date)return e;r={};for(t in e)Array.isArray(e[t])?r[t]=e[t].slice(0):e[t]instanceof Buffer?r[t]=e[t].slice(0):"function"!=typeof e[t]?r[t]=e[t]instanceof Object?exports.clone(e[t]):e[t]:"function"==typeof e[t]&&(r[t]=e[t]);return r},exports.log=function(o){var r,a,c="function"==typeof o.timestamp?o.timestamp:exports.timestamp,s=o.timestamp?c():null,i=void 0!==o.meta||null!==o.meta?exports.clone(n.decycle(o.meta)):null;return o.raw?("object"!=typeof i&&null!=i&&(i={meta:i}),r=exports.clone(i)||{},r.level=o.level,r.message=o.message.stripColors,JSON.stringify(r)):o.json?("object"!=typeof i&&null!=i&&(i={meta:i}),r=exports.clone(i)||{},r.level=o.level,r.message=o.message,s&&(r.timestamp=s),o.logstash===!0&&(a={},void 0!==r.message&&(a["@message"]=r.message,delete r.message),void 0!==r.timestamp&&(a["@timestamp"]=r.timestamp,delete r.timestamp),a["@fields"]=exports.clone(r),r=a),"function"==typeof o.stringify?o.stringify(r):JSON.stringify(r,function(t,e){return e instanceof Buffer?e.toString("base64"):e})):(r=s?s+" - ":"",r+=o.colorize?e.colorize(o.level):o.level,r+=": ",r+=o.label?"["+o.label+"] ":"",r+=o.message,null!==i&&void 0!==i&&(i&&i instanceof Error&&i.stack&&(i=i.stack),"object"!=typeof i?r+=" "+i:Object.keys(i).length>0&&(r+=" "+(o.prettyPrint?"\n"+t.inspect(i,!1,null,o.colorize):exports.serialize(i)))),r)},exports.capitalize=function(e){return e&&e[0].toUpperCase()+e.slice(1)},exports.hash=function(e){return r.createHash("sha1").update(e).digest("hex")},exports.pad=function(e){return 10>e?"0"+e.toString(10):e.toString(10)},exports.timestamp=function(){return(new Date).toISOString()},exports.serialize=function(e,i){var n,r,a,t,o,s;if(null===e?e="null":void 0===e?e="undefined":e===!1&&(e="false"),"object"!=typeof e)return i?i+"="+e:e;if(e instanceof Buffer)return i?i+"="+e.toString("base64"):e.toString("base64");for(n="",r=Object.keys(e),a=r.length,t=0;a>t;t++){if(Array.isArray(e[r[t]])){for(n+=r[t]+"=[",o=0,s=e[r[t]].length;s>o;o++)n+=exports.serialize(e[r[t]][o]),s-1>o&&(n+=", ");n+="]"}else n+=e[r[t]]instanceof Date?r[t]+"="+e[r[t]]:exports.serialize(e[r[t]],r[t]);a-1>t&&(n+=", ")}return n},exports.tailFile=function(t,i){function s(){setTimeout(function(){e.resume()},1e3)}var n,e=o.createReadStream(t.file,{encoding:"utf8"}),r="",a=0;return n=e.destroy.bind(e),e.destroy=function(){},-1===t.start&&delete t.start,e.on("data",function(e){for(var e=(r+e).split(/\n+/),o=e.length-1,n=0;o>n;n++)(null==t.start||a>t.start)&&i(null,e[n]),a++;r=e[o]}),e.on("error",function(e){i(e),n()}),e.on("end",function(){r&&(e.emit("line",r),r=""),s()}),n};