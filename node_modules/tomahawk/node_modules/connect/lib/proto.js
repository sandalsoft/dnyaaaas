function o(e){"test"!==n&&console.error(e.stack||""+e)}var i=require("finalhandler"),t=require("http"),r=require("debug")("connect:dispatcher"),s=require("parseurl"),e=module.exports={},n=process.env.NODE_ENV||"development";e.use=function(e,n){if("string"!=typeof e&&(n=e,e="/"),"function"==typeof n.handle){var o=n;o.route=e,n=function(e,t,r){o.handle(e,t,r)}}return n instanceof t.Server&&(n=n.listeners("request")[0]),"/"==e[e.length-1]&&(e=e.slice(0,-1)),r("use %s %s",e||"/",n.name||"anonymous"),this.stack.push({route:e,handle:n}),this},e.handle=function(e,u,h){function t(o){var n,i,f,h;if(p&&(e.url=e.url.substr(1),p=!1),e.url=a+c+e.url.substr(a.length),e.originalUrl=e.originalUrl||e.url,c="",n=m[g++],!n)return void d(o);try{if(i=s(e).pathname,void 0==i&&(i="/"),0!=i.toLowerCase().indexOf(n.route.toLowerCase()))return t(o);if(f=i[n.route.length],f&&"/"!=f&&"."!=f)return t(o);c=n.route,e.url=a+e.url.substr(a.length+c.length),l||"/"==e.url[0]||(e.url="/"+e.url,p=!0),r("%s %s : %s",n.handle.name||"anonymous",n.route,e.originalUrl),h=n.handle.length,o?4===h?n.handle(o,e,u,t):t(o):4>h?n.handle(e,u,t):t()}catch(y){t(y)}}var m=this.stack,f=1+e.url.indexOf("?"),y=f?f-1:e.url.length,l=1+e.url.substr(0,y).indexOf("://"),a=l?e.url.substr(0,e.url.indexOf("/",2+l)):"",c="",p=!1,g=0,d=h||i(e,u,{env:n,onerror:o});t()},e.listen=function(){var e=t.createServer(this);return e.listen.apply(e,arguments)};