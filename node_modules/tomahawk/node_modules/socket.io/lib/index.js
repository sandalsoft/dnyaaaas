function e(r,t){return this instanceof e?("object"!=typeof r||r.listen||(t=r,r=null),t=t||{},this.nsps={},this.path(t.path||"/socket.io"),this.serveClient(!1!==t.serveClient),this.adapter(t.adapter||p),this.origins(t.origins||"*:*"),this.sockets=this.of("/"),void(r&&this.attach(r,t))):new e(r,t)}var n,r,a=require("http"),c=require("fs").readFileSync,f=require("url").parse,s=require("engine.io"),h=require("socket.io-client"),o=require("socket.io-client/package").version,u=require("./client"),i=require("./namespace"),p=require("socket.io-adapter"),t=require("debug")("socket.io:server"),l=require("url");module.exports=e,n=c(require.resolve("socket.io-client/socket.io.js"),"utf-8"),e.prototype.checkRequest=function(n,r){var e,o,t=n.headers.origin||n.headers.referer;if("null"==t&&(t="*"),-1!==this._origins.indexOf("*:*"))return r(null,!0);if(t)try{return e=l.parse(t),e.port=e.port||80,o=~this._origins.indexOf(e.hostname+":"+e.port)||~this._origins.indexOf(e.hostname+":*")||~this._origins.indexOf("*:"+e.port),r(null,!!o)}catch(i){}r(null,!1)},e.prototype.serveClient=function(e){return arguments.length?(this._serveClient=e,this):this._serveClient},r={transports:"transports","heartbeat timeout":"pingTimeout","heartbeat interval":"pingInterval","destroy buffer size":"maxHttpBufferSize"},e.prototype.set=function(e,t){return"authorization"==e&&t?this.use(function(r,e){t(r.request,function(t,r){return t?e(Error(t)):r?void e():e(Error("Not authorized"))})}):"origins"==e&&t?this.origins(t):"resource"==e?this.path(t):r[e]&&this.eio[r[e]]?this.eio[r[e]]=t:console.error("Option %s is not valid. Please refer to the README.",e),this},e.prototype.path=function(e){return arguments.length?(this._path=e.replace(/\/$/,""),this):this._path},e.prototype.adapter=function(t){if(!arguments.length)return this._adapter;this._adapter=t;for(var e in this.nsps)this.nsps.hasOwnProperty(e)&&this.nsps[e].initAdapter();return this},e.prototype.origins=function(e){return arguments.length?(this._origins=e,this):this._origins},e.prototype.listen=e.prototype.attach=function(e,r){var n,o;if("function"==typeof e)throw n="You are trying to attach socket.io to an expressrequest handler function. Please pass a http.Server instance.",Error(n);return+e==e&&(e=+e),"number"==typeof e&&(t("creating http server and binding to %d",e),o=e,e=a.Server(function(t,e){e.writeHead(404),e.end()}),e.listen(o)),r=r||{},r.path=r.path||"/socket.io",r.allowRequest=this.checkRequest.bind(this),t("creating engine.io instance with opts %j",r),this.eio=s.attach(e,r),this._serveClient&&this.attachServe(e),this.bind(this.eio),this},e.prototype.attachServe=function(e){var n,r,o;t("attaching client serving req handler"),n=this._path+"/socket.io.js",r=e.listeners("request").slice(0),o=this,e.removeAllListeners("request"),e.on("request",function(t,s){if(0==t.url.indexOf(n))o.serve(t,s);else for(var i=0;i<r.length;i++)r[i].call(e,t,s)})},e.prototype.serve=function(r,e){return r.headers.etag&&o==r.headers.etag?(t("serve client 304"),e.writeHead(304),void e.end()):(t("serve client source"),e.setHeader("Content-Type","application/javascript"),e.setHeader("ETag",o),e.writeHead(200),void e.end(n))},e.prototype.bind=function(e){return this.engine=e,this.engine.on("connection",this.onconnection.bind(this)),this},e.prototype.onconnection=function(e){t("incoming connection with id %s",e.id);var r=new u(this,e);return r.connect("/"),this},e.prototype.of=function(e,r){if(!this.nsps[e]){t("initializing namespace %s",e);var n=new i(this,e);this.nsps[e]=n}return r&&this.nsps[e].on("connect",r),this.nsps[e]},["on","to","in","use","emit","send","write"].forEach(function(t){e.prototype[t]=function(){var e=this.sockets[t];return e.apply(this.sockets,arguments)}}),i.flags.forEach(function(t){e.prototype.__defineGetter__(t,function(e){return this.flags.push(e),this})}),e.listen=e;