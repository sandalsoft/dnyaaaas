function i(){}function s(e){var t="",n=!1;return t+=e.type,exports.BINARY_EVENT!=e.type&&exports.BINARY_ACK!=e.type||(t+=e.attachments,t+="-"),e.nsp&&"/"!=e.nsp&&(n=!0,t+=e.nsp),null!=e.id&&(n&&(t+=",",n=!1),t+=e.id),null!=e.data&&(n&&(t+=","),t+=o.stringify(e.data)),r("encoded %j as %s",e,t),t}function u(e,r){function n(o){var e=t.deconstructPacket(o),i=s(e.packet),n=e.buffers;n.unshift(i),r(n)}t.removeBlobs(e,n)}function e(){this.reconstructor=null}function c(n){var i,s,e={},t=0;if(e.type=+n.charAt(0),null==exports.types[e.type])return a();if(exports.BINARY_EVENT==e.type||exports.BINARY_ACK==e.type){for(e.attachments="";"-"!=n.charAt(++t);)e.attachments+=n.charAt(t);e.attachments=+e.attachments}if("/"==n.charAt(t+1))for(e.nsp="";++t&&(i=n.charAt(t),","!=i)&&(e.nsp+=i,t+1!=n.length););else e.nsp="/";if(s=n.charAt(t+1),""!=s&&+s==s){for(e.id="";++t;){if(i=n.charAt(t),null==i||+i!=i){--t;break}if(e.id+=n.charAt(t),t+1==n.length)break}e.id=+e.id}if(n.charAt(++t))try{e.data=o.parse(n.substr(t))}catch(c){return a()}return r("decoded %s as %j",n,e),e}function n(e){this.reconPack=e,this.buffers=[]}function a(){return{type:exports.ERROR,data:"parser error"}}var r=require("debug")("socket.io-parser"),o=require("json3"),p=require("isarray"),l=require("emitter"),t=require("./binary");exports.protocol=3,exports.types=["CONNECT","DISCONNECT","EVENT","BINARY_EVENT","ACK","BINARY_ACK","ERROR"],exports.CONNECT=0,exports.DISCONNECT=1,exports.EVENT=2,exports.ACK=3,exports.ERROR=4,exports.BINARY_EVENT=5,exports.BINARY_ACK=6,exports.Encoder=i,i.prototype.encode=function(e,t){if(r("encoding packet %j",e),exports.BINARY_EVENT==e.type||exports.BINARY_ACK==e.type)u(e,t);else{var n=s(e);t([n])}},exports.Decoder=e,l(e.prototype),e.prototype.add=function(t){var e;if("string"==typeof t)e=c(t),exports.BINARY_EVENT==e.type||exports.BINARY_ACK==e.type?(this.reconstructor=new n(e),0==this.reconstructor.reconPack.attachments&&this.emit("decoded",e)):this.emit("decoded",e);else{if(!(global.Buffer&&Buffer.isBuffer(t)||global.ArrayBuffer&&t instanceof ArrayBuffer||t.base64))throw Error("Unknown type: "+t);if(!this.reconstructor)throw Error("got binary data when not reconstructing a packet");e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,this.emit("decoded",e))}},e.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},n.prototype.takeBinaryData=function(e){if(this.buffers.push(e),this.buffers.length==this.reconPack.attachments){var r=t.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),r}return null},n.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]};