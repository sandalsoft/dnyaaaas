function e(r,t){return this instanceof e?(r&&"object"==typeof r&&(t=r,r=void 0),t=t||{},t.path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=r,this.connected=0,this.attempts=0,this.encoding=!1,this.packetBuffer=[],this.encoder=new o.Encoder,this.decoder=new o.Decoder,void this.open()):new e(r,t)}var c=require("./url"),i=require("engine.io-client"),s=require("./socket"),a=require("component-emitter"),o=require("socket.io-parser"),r=require("./on"),n=require("component-bind"),u=require("object-component"),t=require("debug")("socket.io-client:manager");module.exports=e,e.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var e in this.nsps)this.nsps[e].emit.apply(this.nsps[e],arguments)},a(e.prototype),e.prototype.reconnection=function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection},e.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},e.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this):this._reconnectionDelay},e.prototype.reconnectionDelayMax=function(e){return arguments.length?(this._reconnectionDelayMax=e,this):this._reconnectionDelayMax},e.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},e.prototype.maybeReconnectOnOpen=function(){this.openReconnect||this.reconnecting||!this._reconnection||(this.openReconnect=!0,this.reconnect())},e.prototype.open=e.prototype.connect=function(s){var n,e,a,c,o,u;return t("readyState %s",this.readyState),~this.readyState.indexOf("open")?this:(t("opening %s",this.uri),this.engine=i(this.uri,this.opts),n=this.engine,e=this,this.readyState="opening",a=r(n,"open",function(){e.onopen(),s&&s()}),c=r(n,"error",function(r){if(t("connect_error"),e.cleanup(),e.readyState="closed",e.emitAll("connect_error",r),s){var n=Error("Connection error");n.data=r,s(n)}e.maybeReconnectOnOpen()}),!1!==this._timeout&&(o=this._timeout,t("connect attempt will timeout after %d",o),u=setTimeout(function(){t("connect attempt timed out after %d",o),a.destroy(),n.close(),n.emit("error","timeout"),e.emitAll("connect_timeout",o)},o),this.subs.push({destroy:function(){clearTimeout(u)}})),this.subs.push(a),this.subs.push(c),this)},e.prototype.onopen=function(){t("open"),this.cleanup(),this.readyState="open",this.emit("open");var e=this.engine;this.subs.push(r(e,"data",n(this,"ondata"))),this.subs.push(r(this.decoder,"decoded",n(this,"ondecoded"))),this.subs.push(r(e,"error",n(this,"onerror"))),this.subs.push(r(e,"close",n(this,"onclose")))},e.prototype.ondata=function(e){this.decoder.add(e)},e.prototype.ondecoded=function(e){this.emit("packet",e)},e.prototype.onerror=function(e){t("error",e),this.emitAll("error",e)},e.prototype.socket=function(t){var r,e=this.nsps[t];return e||(e=new s(this,t),this.nsps[t]=e,r=this,e.on("connect",function(){r.connected++})),e},e.prototype.destroy=function(){--this.connected||this.close()},e.prototype.packet=function(r){t("writing packet %j",r);var e=this;e.encoding?e.packetBuffer.push(r):(e.encoding=!0,this.encoder.encode(r,function(r){for(var t=0;t<r.length;t++)e.engine.write(r[t]);e.encoding=!1,e.processPacketQueue()}))},e.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var e=this.packetBuffer.shift();this.packet(e)}},e.prototype.cleanup=function(){for(var e;e=this.subs.shift();)e.destroy();this.packetBuffer=[],this.encoding=!1,this.decoder.destroy()},e.prototype.close=e.prototype.disconnect=function(){this.skipReconnect=!0,this.engine.close()},e.prototype.onclose=function(e){t("close"),this.cleanup(),this.readyState="closed",this.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()},e.prototype.reconnect=function(){var e,r,n;return this.reconnecting?this:(e=this,this.attempts++,void(this.attempts>this._reconnectionAttempts?(t("reconnect failed"),this.emitAll("reconnect_failed"),this.reconnecting=!1):(r=this.attempts*this.reconnectionDelay(),r=Math.min(r,this.reconnectionDelayMax()),t("will wait %dms before reconnect attempt",r),this.reconnecting=!0,n=setTimeout(function(){t("attempting reconnect"),e.emitAll("reconnect_attempt",e.attempts),e.emitAll("reconnecting",e.attempts),e.open(function(r){r?(t("reconnect attempt error"),e.reconnecting=!1,e.reconnect(),e.emitAll("reconnect_error",r.data)):(t("reconnect success"),e.onreconnect())})},r),this.subs.push({destroy:function(){clearTimeout(n)}}))))},e.prototype.onreconnect=function(){var e=this.attempts;this.attempts=0,this.reconnecting=!1,this.emitAll("reconnect",e)};