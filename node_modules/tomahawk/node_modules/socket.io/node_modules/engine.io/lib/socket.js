function e(e,t,r,n){this.id=e,this.server=t,this.upgraded=!1,this.readyState="opening",this.writeBuffer=[],this.packetsFn=[],this.sentCallbackFn=[],this.request=n,this.checkIntervalTimer=null,this.upgradeTimeoutTimer=null,this.pingTimeoutTimer=null,this.setTransport(r),this.onOpen()}var r=require("events").EventEmitter,t=require("debug")("engine:socket");module.exports=e,e.prototype.__proto__=r.prototype,e.prototype.onOpen=function(){this.readyState="open",this.transport.sid=this.id,this.sendPacket("open",JSON.stringify({sid:this.id,upgrades:this.getAvailableUpgrades(),pingInterval:this.server.pingInterval,pingTimeout:this.server.pingTimeout})),this.emit("open"),this.setPingTimeout()},e.prototype.onPacket=function(e){if("open"==this.readyState)switch(t("packet"),this.emit("packet",e),this.setPingTimeout(),e.type){case"ping":t("got ping"),this.sendPacket("pong"),this.emit("heartbeat");break;case"error":this.onClose("parse error");break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else t("packet received with closed socket")},e.prototype.onError=function(e){t("transport error"),this.onClose("transport error",e)},e.prototype.setPingTimeout=function(){var e=this;clearTimeout(e.pingTimeoutTimer),e.pingTimeoutTimer=setTimeout(function(){e.onClose("ping timeout")},e.server.pingInterval+e.server.pingTimeout)},e.prototype.setTransport=function(e){this.transport=e,this.transport.once("error",this.onError.bind(this)),this.transport.on("packet",this.onPacket.bind(this)),this.transport.on("drain",this.flush.bind(this)),this.transport.once("close",this.onClose.bind(this,"transport close")),this.setupSendCallback()},e.prototype.maybeUpgrade=function(r){function n(i){"ping"==i.type&&"probe"==i.data?(r.send([{type:"pong",data:"probe"}]),clearInterval(e.checkIntervalTimer),e.checkIntervalTimer=setInterval(o,100)):"upgrade"==i.type&&"open"==e.readyState?(t("got upgrade packet - upgrading"),e.upgraded=!0,e.clearTransport(),e.setTransport(r),e.emit("upgrade",r),e.setPingTimeout(),e.flush(),clearInterval(e.checkIntervalTimer),e.checkIntervalTimer=null,clearTimeout(e.upgradeTimeoutTimer),r.removeListener("packet",n)):r.close()}function o(){"polling"==e.transport.name&&e.transport.writable&&(t("writing a noop packet to polling for fast upgrade"),e.transport.send([{type:"noop"}]))}t('might upgrade socket transport from "%s" to "%s"',this.transport.name,r.name);var e=this;e.upgradeTimeoutTimer=setTimeout(function(){t("client did not complete upgrade - closing transport"),clearInterval(e.checkIntervalTimer),e.checkIntervalTimer=null,"open"==r.readyState&&r.close()},this.server.upgradeTimeout),r.on("packet",n)},e.prototype.clearTransport=function(){this.transport.on("error",function(){t("error triggered by discarded transport")}),clearTimeout(this.pingTimeoutTimer)},e.prototype.onClose=function(e,t){if("closed"!=this.readyState){clearTimeout(this.pingTimeoutTimer),clearInterval(this.checkIntervalTimer),this.checkIntervalTimer=null,clearTimeout(this.upgradeTimeoutTimer);var r=this;process.nextTick(function(){r.writeBuffer=[]}),this.packetsFn=[],this.sentCallbackFn=[],this.clearTransport(),this.readyState="closed",this.emit("close",e,t)}},e.prototype.setupSendCallback=function(){var e=this;this.transport.on("drain",function(){var r,o,n;if(e.sentCallbackFn.length>0)if(r=e.sentCallbackFn.splice(0,1)[0],"function"==typeof r)t("executing send callback"),r(e.transport);else if(Array.isArray(r))for(t("executing batch send callback"),o=r.length,n=0;o>n;n++)"function"==typeof r[n]&&r[n](e.transport)})},e.prototype.send=e.prototype.write=function(e,t){return this.sendPacket("message",e,t),this},e.prototype.sendPacket=function(n,e,o){if("closing"!=this.readyState){t('sending packet "%s" (%s)',n,e);var r={type:n};e&&(r.data=e),this.emit("packetCreate",r),this.writeBuffer.push(r),this.packetsFn.push(o),this.flush()}},e.prototype.flush=function(){if("closed"!=this.readyState&&this.transport.writable&&this.writeBuffer.length){t("flushing buffer to transport"),this.emit("flush",this.writeBuffer),this.server.emit("flush",this,this.writeBuffer);var e=this.writeBuffer;this.writeBuffer=[],this.transport.supportsFraming?this.sentCallbackFn.push.apply(this.sentCallbackFn,this.packetsFn):this.sentCallbackFn.push(this.packetsFn),this.packetsFn=[],this.transport.send(e),this.emit("drain"),this.server.emit("drain",this)}},e.prototype.getAvailableUpgrades=function(){var e,r,t,n=[],o=this.server.upgrades(this.transport.name);for(e=0,r=o.length;r>e;++e)t=o[e],-1!=this.server.transports.indexOf(t)&&n.push(t);return n},e.prototype.close=function(){if("open"==this.readyState){this.readyState="closing";var e=this;this.transport.close(function(){e.onClose("forced close")})}};