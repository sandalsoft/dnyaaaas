function e(t){return this instanceof e?(this.clients={},this.clientsCount=0,t=t||{},this.pingTimeout=t.pingTimeout||6e4,this.pingInterval=t.pingInterval||25e3,this.upgradeTimeout=t.upgradeTimeout||1e4,this.maxHttpBufferSize=t.maxHttpBufferSize||1e8,this.transports=t.transports||Object.keys(r),this.allowUpgrades=!1!==t.allowUpgrades,this.allowRequest=t.allowRequest,this.cookie=!1!==t.cookie?t.cookie||"io":!1,void(~this.transports.indexOf("websocket")&&(this.ws=new c({noServer:!0,clientTracking:!1})))):new e(t)}function n(r,n,o){var t={"Content-Type":"application/json"};r.headers.origin?(t["Access-Control-Allow-Credentials"]="true",t["Access-Control-Allow-Origin"]=r.headers.origin):t["Access-Control-Allow-Origin"]="*",n.writeHead(400,t),n.end(JSON.stringify({code:o,message:e.errorMessages[o]}))}var o=require("querystring"),i=require("url").parse,l=require("fs").readFileSync,p=require("crypto"),u=require("base64id"),r=require("./transports"),s=require("events").EventEmitter,a=require("./socket"),c=require("ws").Server,t=require("debug")("engine");module.exports=e,e.errors={UNKNOWN_TRANSPORT:0,UNKNOWN_SID:1,BAD_HANDSHAKE_METHOD:2,BAD_REQUEST:3},e.errorMessages={0:"Transport unknown",1:"Session ID unknown",2:"Bad handshake method",3:"Bad request"},e.prototype.__proto__=s.prototype,e.prototype.clients,e.prototype.upgrades=function(e){return this.allowUpgrades?r[e].upgradesTo||[]:[]},e.prototype.verify=function(n,s,r){var o,i=n._query.transport;return~this.transports.indexOf(i)?(o=n._query.sid)?this.clients.hasOwnProperty(o)?s||this.clients[o].transport.name===i?void r(null,!0):(t("bad request: unexpected transport without upgrade"),r(e.errors.BAD_REQUEST,!1)):r(e.errors.UNKNOWN_SID,!1):"GET"!=n.method?r(e.errors.BAD_HANDSHAKE_METHOD,!1):this.allowRequest?this.allowRequest(n,r):r(null,!0):(t('unknown transport "%s"',i),r(e.errors.UNKNOWN_TRANSPORT,!1))},e.prototype.prepare=function(e){e._query||(e._query=~e.url.indexOf("?")?o.parse(i(e.url).query):{})},e.prototype.close=function(){t("closing all open clients");for(var e in this.clients)this.clients[e].close();return this},e.prototype.handleRequest=function(e,r){t('handling "%s" http request "%s"',e.method,e.url),this.prepare(e),e.res=r;var o=this;this.verify(e,!1,function(i,s){return s?void(e._query.sid?(t("setting new request for existing client"),o.clients[e._query.sid].transport.onRequest(e)):o.handshake(e._query.transport,e)):void n(e,r,i)})},e.prototype.handshake=function(o,i){var p,c,l,s=u.generateId();t('handshaking client "%s"',s),p=o;try{o=new r[o](i),"polling"==p&&(o.maxHttpBufferSize=this.maxHttpBufferSize),i._query&&i._query.b64?o.supportsBinary=!1:o.supportsBinary=!0}catch(f){return void n(i,i.res,e.errors.BAD_REQUEST)}c=new a(s,this,o,i),l=this,!1!==this.cookie&&o.on("headers",function(e){e["Set-Cookie"]=l.cookie+"="+s}),o.onRequest(i),this.clients[s]=c,this.clientsCount++,c.once("close",function(){delete l.clients[s],l.clientsCount--}),this.emit("connection",c)},e.prototype.handleUpgrade=function(e,t,n){this.prepare(e);var r=this;this.verify(e,!0,function(i,o){return o?void r.ws.handleUpgrade(e,t,n,function(t){r.onWebSocket(e,t)}):void t.end()})},e.prototype.onWebSocket=function(e,o){var n,i;return r[e._query.transport].prototype.handlesUpgrades?(n=e._query.sid,e.websocket=o,void(n?this.clients[n]?this.clients[n].upgraded?(t("transport had already been upgraded"),o.close()):(t("upgrading existing transport"),i=new r[e._query.transport](e),e._query&&e._query.b64?i.supportsBinary=!1:i.supportsBinary=!0,this.clients[n].maybeUpgrade(i)):(t("upgrade attempt for closed client"),o.close()):this.handshake(e._query.transport,e))):(t("transport doesnt handle upgraded requests"),void o.close())},e.prototype.attach=function(r,e){function s(e){return n==e.url.substr(0,n.length)}var n,a,c,i,o=this;e=e||{},n=(e.path||"/engine.io").replace(/\/$/,""),a=void 0!==e.destroyUpgrade?e.destroyUpgrade:!0,c=e.destroyUpgradeTimeout||1e3,n+="/",i=r.listeners("request").slice(0),r.removeAllListeners("request"),r.on("close",o.close.bind(o)),r.on("request",function(e,c){if(s(e))t('intercepting request for path "%s"',n),o.handleRequest(e,c);else for(var a=0,u=i.length;u>a;a++)i[a].call(r,e,c)}),~o.transports.indexOf("websocket")&&r.on("upgrade",function(r,t,n){s(r)?o.handleUpgrade(r,t,n):!1!==e.destroyUpgrade&&setTimeout(function(){return t.writable&&t.bytesWritten<=0?t.end():void 0},e.destroyUpgradeTimeout)})};