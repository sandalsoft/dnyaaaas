function t(e){r.call(this,e)}var r=require("../transport"),n=require("engine.io-parser"),e=require("debug")("engine:polling");module.exports=t,t.prototype.__proto__=r.prototype,t.prototype.name="polling",t.prototype.onRequest=function(e){var t=e.res;"GET"==e.method?this.onPollRequest(e,t):"POST"==e.method?this.onDataRequest(e,t):(t.writeHead(500),t.end())},t.prototype.onPollRequest=function(t,n){function o(){r.onError("poll connection closed prematurely")}function s(){t.removeListener("close",o),r.req=r.res=null}if(this.req)return e("request overlap"),this.onError("overlap from client"),void n.writeHead(500);e("setting request"),this.req=t,this.res=n;var r=this;t.cleanup=s,t.on("close",o),this.writable=!0,this.emit("drain"),this.writable&&this.shouldClose&&(e("triggering empty send to append close packet"),this.send([{type:"noop"}]))},t.prototype.onDataRequest=function(e,n){function s(){t=o?new Buffer(0):"",e.removeListener("data",a),e.removeListener("end",c),e.removeListener("close",i),r.dataReq=r.dataRes=null}function i(){s(),r.onError("data request connection closed prematurely")}function a(n){var o;"string"==typeof n?(t+=n,o=Buffer.byteLength(t)):(t=Buffer.concat([t,n]),o=t.length),o>r.maxHttpBufferSize&&(t="",e.connection.destroy())}function c(){r.onData(t),n.writeHead(200,r.headers(e,{"Content-Length":2,"Content-Type":"text/html"})),n.end("ok"),s()}var o,t,r;return this.dataReq?(this.onError("data request overlap from client"),void n.writeHead(500)):(o="application/octet-stream"==e.headers["content-type"],this.dataReq=e,this.dataRes=n,t=o?new Buffer(0):"",r=this,e.abort=s,e.on("close",i),e.on("data",a),e.on("end",c),void(o||e.setEncoding("utf8")))},t.prototype.onData=function(r){var t,o;e('received "%s"',r),t=this,o=function(r){return"close"==r.type?(e("got xhr close packet"),t.onClose(),!1):void t.onPacket(r)},n.decodePayload(r,o)},t.prototype.send=function(t){this.shouldClose&&(e("appending close packet to payload"),t.push({type:"close"}),this.shouldClose(),this.shouldClose=null);var r=this;n.encodePayload(t,this.supportsBinary,function(e){r.write(e)})},t.prototype.write=function(t){e('writing "%s"',t),this.doWrite(t),this.req.cleanup(),this.writable=!1},t.prototype.doClose=function(t){e("closing"),this.dataReq&&(e("aborting ongoing data request"),this.dataReq.abort()),this.writable?(e("transport writable - closing right away"),this.send([{type:"close"}]),t()):(e("transport not writable - buffering orderly close"),this.shouldClose=t)};