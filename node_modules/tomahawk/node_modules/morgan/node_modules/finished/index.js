var e=require("ee-first"),r="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};module.exports=function(n,i){var t,a=n.socket||n,o=n.res||n;return o.finished||!a.writable?(r(i),n):(t=o.__onFinished,t&&t.queue||(t=o.__onFinished=function(r){o.__onFinished===t&&(o.__onFinished=null);for(var e=t.queue||[];e.length;)e.shift()(r)},t.queue=[],e([[a,"error","close"],[o,"finish"]],t)),t.queue.push(i),n)};