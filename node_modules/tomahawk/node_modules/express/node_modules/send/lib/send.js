function g(t,r,n){return new e(t,r,n)}function e(t,r,e){e=e||{},this.req=t,this.path=r,this.options=e,this._etag=void 0!==e.etag?!!e.etag:!0,this._hidden=!!e.hidden,this._index=void 0!==e.index?c(e.index):["index.html"],this._maxage=e.maxAge||e.maxage,this._maxage="string"==typeof this._maxage?p(this._maxage):+this._maxage,this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),w),this._root=e.root?i(e.root):null,!this._root&&e.from&&this.from(e.from)}function c(e){return[].concat(e||[])}var o,t=require("debug")("send"),r=require("depd")("send"),u=require("escape-html"),x=require("range-parser"),d=require("stream"),n=require("mime"),v=require("fresh"),a=require("path"),f=require("http"),h=require("finished"),s=require("fs"),m=a.basename,i=a.normalize,y=a.join,l=require("./utils"),b=require("events").EventEmitter,p=require("ms"),w=31536e6,k=/(?:^|[\\\/])\.\.(?:[\\\/]|$)/;exports=module.exports=g,exports.mime=n,o=b.listenerCount||function(e,t){return e.listeners(t).length},e.prototype.__proto__=d.prototype,e.prototype.etag=r.function(function(e){return e=!!e,t("etag %s",e),this._etag=e,this},"send.etag: pass etag as option"),e.prototype.hidden=r.function(function(e){return e=!!e,t("hidden %s",e),this._hidden=e,this},"send.hidden: pass hidden as option"),e.prototype.index=r.function(function E(e){var E=e?c(e):[];return t("index %o",e),this._index=E,this},"send.index: pass index as option"),e.prototype.root=function(e){return e+="",this._root=i(e),this},e.prototype.from=r.function(e.prototype.root,"send.from: pass root as option"),e.prototype.root=r.function(e.prototype.root,"send.root: pass root as option"),e.prototype.maxage=r.function(function(e){return e="string"==typeof e?p(e):+e,isNaN(e)&&(e=0),1/0==e&&(e=31536e6),t("max-age %d",e),this._maxage=e,this},"send.maxage: pass maxAge as option"),e.prototype.error=function(r,e){var t=this.res,n=f.STATUS_CODES[r];return e=e||Error(n),e.status=r,0!==o(this,"error")?this.emit("error",e):(t._headers=void 0,t.statusCode=e.status,void t.end(n))},e.prototype.isMalicious=function(){return!this._root&&~this.path.indexOf("..")&&k.test(this.path)},e.prototype.hasTrailingSlash=function(){return"/"==this.path[this.path.length-1]},e.prototype.hasLeadingDot=function(){return"."==m(this.path)[0]},e.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]},e.prototype.removeContentHeaderFields=function(){var e=this.res;Object.keys(e._headers).forEach(function(t){0==t.indexOf("content")&&e.removeHeader(t)})},e.prototype.notModified=function(){var e=this.res;t("not modified"),this.removeContentHeaderFields(),e.statusCode=304,e.end()},e.prototype.headersAlreadySent=function(){var e=Error("Can't set headers after they are sent.");t("headers already sent"),this.error(500,e)},e.prototype.isCachable=function(){var e=this.res;return e.statusCode>=200&&e.statusCode<300||304==e.statusCode},e.prototype.onStatError=function(e){var t=["ENOENT","ENAMETOOLONG","ENOTDIR"];return~t.indexOf(e.code)?this.error(404,e):void this.error(500,e)},e.prototype.isFresh=function(){return v(this.req.headers,this.res._headers)},e.prototype.isRangeFresh=function(){var e=this.req.headers["if-range"];return e?~e.indexOf('"')?~e.indexOf(this.res._headers.etag):Date.parse(this.res._headers["last-modified"])<=Date.parse(e):!0},e.prototype.redirect=function(e){if(0!==o(this,"directory"))return this.emit("directory");if(this.hasTrailingSlash())return this.error(403);var t=this.res;e+="/",t.statusCode=301,t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Location",e),t.end('Redirecting to <a href="'+u(e)+'">'+u(e)+"</a>\n")},e.prototype.pipe=function(n){var r=this,e=this.path,o=this._root;return this.res=n,e=l.decode(e),-1==e?this.error(400):~e.indexOf("\x00")?this.error(400):(o&&(e=i(y(this._root,e))),this.isMalicious()?this.error(403):o&&0!=e.indexOf(o)?this.error(403):!this._hidden&&this.hasLeadingDot()?this.error(404):this._index.length&&this.hasTrailingSlash()?(this.sendIndex(e),n):(t('stat "%s"',e),s.stat(e,function(n,t){return n?r.onStatError(n):t.isDirectory()?r.redirect(r.path):(r.emit("file",e,t),void r.send(e,t))}),n))},e.prototype.send=function(s,a){var c,r=this.options,n=a.size,o=this.res,u=this.req,e=u.headers.range,i=r.start||0;if(o._header)return this.headersAlreadySent();if(t("options %o",r),this.setHeader(s,a),this.type(s),this.isConditionalGET()&&this.isCachable()&&this.isFresh())return this.notModified();if(n=Math.max(0,n-i),void 0!==r.end&&(c=r.end-i+1,n>c&&(n=c)),e){if(e=x(n,e),this.isRangeFresh()||(t("range stale"),e=-2),-1==e)return t("range unsatisfiable"),o.setHeader("Content-Range","bytes */"+a.size),this.error(416);-2!=e&&1===e.length&&(t("range %j",e),r.start=i+e[0].start,r.end=i+e[0].end,o.statusCode=206,o.setHeader("Content-Range","bytes "+e[0].start+"-"+e[0].end+"/"+n),n=r.end-r.start+1)}return o.setHeader("Content-Length",n),"HEAD"==u.method?o.end():void this.stream(s,r)},e.prototype.sendIndex=function(n){function r(a){if(++o>=e._index.length)return a?e.onStatError(a):e.error(404);var i=n+e._index[o];t('stat "%s"',i),s.stat(i,function(n,t){return n?r(n):t.isDirectory()?r():(e.emit("file",i,t),void e.send(i,t))})}var o=-1,e=this;this.hasTrailingSlash()||(n+="/"),r()},e.prototype.stream=function(o,i){var t=!1,n=this,r=this.res,a=this.req,e=s.createReadStream(o,i);this.emit("stream",e),e.pipe(r),h(r,function(){t=!0,e.destroy()}),e.on("error",function(o){return t?void 0:(t=!0,e.destroy(),r._header?(console.error(o.stack),void a.destroy()):void n.onStatError(o))}),e.on("end",function(){n.emit("end")})},e.prototype.type=function(i){var e,r,o=this.res;o.getHeader("Content-Type")||(e=n.lookup(i),r=n.charsets.lookup(e),t("content-type %s",e),o.setHeader("Content-Type",e+(r?"; charset="+r:"")))},e.prototype.setHeader=function(o,r){var n,e=this.res;this.emit("headers",e,o,r),e.getHeader("Accept-Ranges")||e.setHeader("Accept-Ranges","bytes"),e.getHeader("Date")||e.setHeader("Date",(new Date).toUTCString()),e.getHeader("Cache-Control")||e.setHeader("Cache-Control","public, max-age="+Math.floor(this._maxage/1e3)),e.getHeader("Last-Modified")||e.setHeader("Last-Modified",r.mtime.toUTCString()),this._etag&&!e.getHeader("ETag")&&(n=l.etag(o,r),t("etag %s",n),e.setHeader("ETag",n))};