var e=require("ee-first"),t="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};module.exports=function(n,i){var r,s=n.socket||n,o=n.res||n;return o.finished||!s.writable?(t(i),n):(r=o.__onFinished,r&&r.queue||(r=o.__onFinished=function(t){o.__onFinished===r&&(o.__onFinished=null);for(var e=r.queue||[];e.length;)e.shift()(t)},r.queue=[],e([[s,"error","close"],[o,"finish"]],r)),r.queue.push(i),n)};