function o(e){"test"!==this.get("env")&&console.error(e.stack||""+e)}var a=require("finalhandler"),r=require("utils-merge"),c=require("./router"),n=require("methods"),i=require("./middleware/init"),s=require("./middleware/query"),t=require("debug")("express:application"),d=require("./view"),u=require("http"),l=require("./utils").compileETag,p=require("./utils").compileTrust,f=require("depd")("express"),h=require("path").resolve,e=exports=module.exports={};e.init=function(){this.cache={},this.settings={},this.engines={},this.defaultConfiguration()},e.defaultConfiguration=function(){this.enable("x-powered-by"),this.set("etag","weak");var e=process.env.NODE_ENV||"development";this.set("env",e),this.set("subdomain offset",2),this.set("trust proxy",!1),t("booting in %s mode",e),this.on("mount",function(e){this.request.__proto__=e.request,this.response.__proto__=e.response,this.engines.__proto__=e.engines,this.settings.__proto__=e.settings}),this.locals=Object.create(null),this.mountpath="/",this.locals.settings=this.settings,this.set("view",d),this.set("views",h("views")),this.set("jsonp callback name","callback"),"production"===e&&this.enable("view cache"),Object.defineProperty(this,"router",{get:function(){throw Error("'app.router' is deprecated!\nPlease see the 3.x to 4.x migration guide for details on how to update your app.")}})},e.lazyrouter=function(){this._router||(this._router=new c({caseSensitive:this.enabled("case sensitive routing"),strict:this.enabled("strict routing")}),this._router.use(s()),this._router.use(i.init(this)))},e.handle=function(r,n,e){var i=this._router;return e=e||a(r,n,{env:this.get("env"),onerror:o.bind(this)}),i?void i.handle(r,n,e):(t("no routes defined on app"),void e())},e.use=function(r,i){var e,n,o;return arguments.length<=2&&(n="string"==typeof r?r:"/",e="function"==typeof r?r:i),this.lazyrouter(),o=this._router,e&&e.handle&&e.set?(t(".use app under %s",n),e.mountpath=n,e.parent=this,o.use(n,function(t,r,o){var n=t.app;e.handle(t,r,function(e){t.__proto__=n.request,r.__proto__=n.response,o(e)})}),e.emit("mount",this),this):(o.use.apply(o,arguments),this)},e.route=function(e){return this.lazyrouter(),this._router.route(e)},e.engine=function(e,t){if("function"!=typeof t)throw Error("callback function required");return"."!=e[0]&&(e="."+e),this.engines[e]=t,this},e.param=function(e,r){var t=this;return t.lazyrouter(),Array.isArray(e)?(e.forEach(function(e){t.param(e,r)}),this):(t._router.param(e,r),this)},e.set=function(r,e){if(1===arguments.length)return this.settings[r];switch(this.settings[r]=e,r){case"etag":t("compile etag %s",e),this.set("etag fn",l(e));break;case"trust proxy":t("compile trust proxy %s",e),this.set("trust proxy fn",p(e))}return this},e.path=function(){return this.parent?this.parent.path()+this.mountpath:""},e.enabled=function(e){return!!this.set(e)},e.disabled=function(e){return!this.set(e)},e.enable=function(e){return this.set(e,!0)},e.disable=function(e){return this.set(e,!1)},n.forEach(function(t){e[t]=function(e){if("get"==t&&1==arguments.length)return this.set(e);this.lazyrouter();var r=this._router.route(e);return r[t].apply(r,[].slice.call(arguments,1)),this}}),e.all=function(r){var e,t;return this.lazyrouter(),e=this._router.route(r),t=[].slice.call(arguments,1),n.forEach(function(r){e[r].apply(e,t)}),this},e.del=f.function(e.delete,"app.del: Use app.delete instead"),e.render=function(o,n,i){var t,s,e={},a=this.cache,c=this.engines;if("function"==typeof n&&(i=n,n={}),r(e,this.locals),n._locals&&r(e,n._locals),r(e,n),e.cache=null==e.cache?this.enabled("view cache"):e.cache,e.cache&&(t=a[o]),!t){if(t=new(this.get("view"))(o,{defaultEngine:this.get("view engine"),root:this.get("views"),engines:c}),!t.path)return s=Error('Failed to lookup view "'+o+'" in views directory "'+t.root+'"'),s.view=t,i(s);e.cache&&(a[o]=t)}try{t.render(e,i)}catch(s){i(s)}},e.listen=function(){var e=u.createServer(this);return e.listen.apply(e,arguments)};