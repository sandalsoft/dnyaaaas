function f(t,n){var i,e,o;if("object"!=typeof n||!n)return t;if(i=r({},n),!(0 in t&&0 in n))return r(i,t);for(e=0,o=0;e===o||o in n;)e in t&&e++,o in n&&o++;for(e--;e>=0;e--)t[e+o]=t[e],o>e&&delete t[e];return r(n,t)}function a(o,r){var e,t=Array(arguments.length-2),n=Array(arguments.length-2);for(e=0;e<t.length;e++)t[e]=arguments[e+2],n[e]=r[t[e]];return function(){for(var e=0;e<t.length;e++)r[t[e]]=n[e];return o.apply(this,arguments)}}function c(e,t){return function(){var r,o,n=Array(arguments.length+1);for(n[0]=e,r=0,o=arguments.length;o>r;r++)n[r+1]=arguments[r];t.apply(this,n)}}var i=require("./route"),n=require("./layer"),s=require("methods"),r=require("utils-merge"),t=require("debug")("express:router"),u=require("parseurl"),o=Array.prototype.slice,l=Object.prototype.toString,p=require("../utils"),e=module.exports=function(r){function t(e,r,n){t.handle(e,r,n)}return r=r||{},t.__proto__=e,t.params={},t._params=[],t.caseSensitive=r.caseSensitive,t.mergeParams=r.mergeParams,t.strict=r.strict,t.stack=[],t};e.param=function(e,t){var n,o,i,r;if("function"==typeof e)return void this._params.push(e);for(n=this._params,o=n.length,":"===e[0]&&(e=e.substr(1)),r=0;o>r;++r)(i=n[r](e,t))&&(t=i);if("function"!=typeof t)throw Error("invalid param() call for "+e+", got "+t);return(this.params[e]=this.params[e]||[]).push(t),this},e.handle=function(e,o,i){function n(c){var a="route"===c?null:c,t=v[x++];return d&&(e.url=e.url.substr(1),d=!1),0!==r.length&&(e.baseUrl=p,e.url=u+r+e.url.substr(u.length),r=""),t?void h.match_layer(t,e,o,function(u,l){var r,i,c,p;if(u||void 0===l)return n(a||u);if(r=t.route){if(a)return n(a);if(i=e.method,c=r._handles_method(i),c||"OPTIONS"!==i||s.push.apply(s,r._options()),!c&&"HEAD"!==i)return n();e.route=r}e.params=h.mergeParams?f(t.params,b):t.params,p=t.path,h.process_params(t,y,e,o,function(i){return i?n(a||i):r?t.handle_request(e,o,n):void w(t,a,p,l)})}):i(a)}function w(s,a,i,f){var c=f[i.length];return c&&"/"!==c&&"."!==c?n(a):(0!==i.length&&(t("trim prefix (%s) from url %s",i,e.url),r=i,e.url=u+e.url.substr(u.length+r.length),l||"/"===e.url[0]||(e.url="/"+e.url,d=!0),e.baseUrl=p+("/"===r[r.length-1]?r.substring(0,r.length-1):r)),t("%s %s : %s",s.name,i,e.originalUrl),void(a?s.handle_error(a,e,o,n):s.handle_request(e,o,n)))}var m,g,l,u,x,r,d,y,s,v,b,p,h=this;t("dispatching %s %s",e.method,e.url),m=1+e.url.indexOf("?"),g=m?m-1:e.url.length,l=1+e.url.substr(0,g).indexOf("://"),u=l?e.url.substr(0,e.url.indexOf("/",2+l)):"",x=0,r="",d=!1,y={},s=[],v=h.stack,b=e.params,p=e.baseUrl||"",i=a(i,e,"baseUrl","next","params"),e.next=n,"OPTIONS"===e.method&&(i=c(i,function(r,e){if(e||0===s.length)return r(e);var t=s.join(",");return o.set("Allow",t).send(t)})),e.baseUrl=p,e.originalUrl=e.originalUrl||e.url,n()},e.match_layer=function(r,n,s,o){var e,t=null;try{e=u(n).pathname,r.match(e)||(e=void 0)}catch(i){t=i}o(t,e)},e.process_params=function(m,f,i,h,o){function n(h){return h?o(h):u>=s.length?o():(c=0,(a=s[u++])?(t=a.name,r=i.params[t],p=d[t],e=f[t],void 0!==r&&p?e&&(e.error||e.match===r)?(i.params[t]=e.value,n(e.error)):(f[t]=e={error:null,match:r,value:r},void l()):n()):o())}function l(t){var o=p[c++];if(e.value=i.params[a.name],t)return e.error=t,void n(t);if(!o)return n();try{o(i,h,l,r,a.name)}catch(s){l(s)}}var u,t,c,a,r,p,e,d=this.params,s=m.keys;return s&&0!==s.length?(u=0,c=0,void n()):o()},e.use=function(i){var e,s=0,r="/",a=this;if("function"!=typeof i&&(s=1,r=i),e=p.flatten(o.call(arguments,s)),0===e.length)throw new TypeError("Router.use() requires callback function");return e.forEach(function(e){var i,s,o;if("function"!=typeof e)throw i=l.call(e),s="Router.use() requires callback function but got a "+i,new TypeError(s);t("use %s %s",r,e.name||"<anonymous>"),o=new n(r,{sensitive:a.caseSensitive,strict:!1,end:!1},e),o.route=void 0,a.stack.push(o)}),this},e.route=function(t){var e=new i(t),r=new n(t,{sensitive:this.caseSensitive,strict:this.strict,end:!0},e.dispatch.bind(e));return r.route=e,this.stack.push(r),e},s.concat("all").forEach(function(t){e[t]=function(r){var e=this.route(r);return e[t].apply(e,o.call(arguments,1)),this}});