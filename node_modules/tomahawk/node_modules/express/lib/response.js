var t=require("depd")("express"),l=require("escape-html"),r=require("http"),a=require("path"),o=require("utils-merge"),m=require("cookie-signature").sign,h=require("./utils").normalizeType,p=require("./utils").normalizeTypes,u=require("./utils").setCharset,n=require("./utils").contentDisposition,c=r.STATUS_CODES,f=require("cookie"),s=require("send"),y=a.basename,d=a.extname,i=s.mime,g=require("vary"),e=module.exports={__proto__:r.ServerResponse.prototype};e.status=function(e){return this.statusCode=e,this},e.links=function(t){var e=this.get("Link")||"";return e&&(e+=", "),this.set("Link",e+Object.keys(t).map(function(e){return"<"+t[e]+'>; rel="'+e+'"'}).join(", "))},e.send=function(c){var o,s,a,n,e=c,i=this.req,l=this.app;switch(2===arguments.length&&("number"!=typeof arguments[0]&&"number"==typeof arguments[1]?(t("res.send(body, status): Use res.send(status, body) instead"),this.statusCode=arguments[1]):(this.statusCode=arguments[0],e=arguments[1])),"number"==typeof e&&1===arguments.length&&(this.get("Content-Type")||this.type("txt"),this.statusCode=e,e=r.STATUS_CODES[e]),typeof e){case"string":this.get("Content-Type")||this.type("html");break;case"boolean":case"number":case"object":if(null===e)e="";else{if(!Buffer.isBuffer(e))return this.json(e);this.get("Content-Type")||this.type("bin")}}return"string"==typeof e&&(o="utf8",a=this.get("Content-Type"),"string"==typeof a&&this.set("Content-Type",u(a,"utf-8"))),void 0===e||this.get("Content-Length")||(s=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e,o),this.set("Content-Length",s)),n=void 0!==s&&l.get("etag fn"),!n||"GET"!==i.method&&"HEAD"!==i.method||this.get("ETag")||(n=n(e,o),n&&this.set("ETag",n)),i.fresh&&(this.statusCode=304),204!=this.statusCode&&304!=this.statusCode||(this.removeHeader("Content-Type"),this.removeHeader("Content-Length"),this.removeHeader("Transfer-Encoding"),e=""),"HEAD"===i.method&&this.end(),this.end(e,o),this},e.json=function(s){var e,r,n,o,i=s;return 2===arguments.length&&("number"==typeof arguments[1]?(this.statusCode=arguments[1],t("number"==typeof arguments[0]?"res.json(obj, status): Use res.json(status, obj) instead":"res.json(num, status): Use res.status(status).json(num) instead")):(this.statusCode=arguments[0],i=arguments[1])),e=this.app,r=e.get("json replacer"),n=e.get("json spaces"),o=JSON.stringify(i,r,n),this.get("Content-Type")||this.set("Content-Type","application/json"),this.send(o)},e.jsonp=function(a){var n,o,i,r,e,s=a;return 2===arguments.length&&("number"==typeof arguments[1]?(this.statusCode=arguments[1],t("number"==typeof arguments[0]?"res.jsonp(obj, status): Use res.jsonp(status, obj) instead":"res.jsonp(num, status): Use res.status(status).jsonp(num) instead")):(this.statusCode=arguments[0],s=arguments[1])),n=this.app,o=n.get("json replacer"),i=n.get("json spaces"),r=JSON.stringify(s,o,i),e=this.req.query[n.get("jsonp callback name")],this.get("Content-Type")||(this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","application/json")),Array.isArray(e)&&(e=e[0]),"string"==typeof e&&0!==e.length&&(this.charset="utf-8",this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","text/javascript"),e=e.replace(/[^\[\]\w$.]/g,""),r=r.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),r="/**/ typeof "+e+" === 'function' && "+e+"("+r+");"),this.send(r)},e.sendfile=function(p,e,r){function c(e){return o?void 0:(o=!0,i(),r?r(e):void a(e))}function l(e){o||(i(),r&&e.on("end",r))}function i(){n.socket.removeListener("error",c)}var u,n,a,o,t;e=e||{},u=this,n=u.req,a=this.req.next,"function"==typeof e&&(r=e,e={}),n.socket.on("error",c),e.maxage=e.maxage||e.maxAge||0,t=s(n,p,e),t.on("error",c),t.on("directory",a),t.on("stream",l),e.headers&&t.on("headers",function(i){var t,r,n=e.headers,o=Object.keys(n);for(t=0;t<o.length;t++)r=o[t],i.setHeader(r,n[r])}),t.pipe(this),this.on("finish",i)},e.download=function(t,e,r){"function"==typeof e&&(r=e,e=null),e=e||t;var o={"Content-Disposition":n(e)};return this.sendfile(t,{headers:o},r)},e.contentType=e.type=function(e){return this.set("Content-Type",~e.indexOf("/")?e:i.lookup(e))},e.format=function(e){var n,t,r,o=this.req,s=o.next,i=e.default;return i&&delete e.default,n=Object.keys(e),t=o.accepts(n),this.vary("Accept"),t?(this.set("Content-Type",h(t).value),e[t](o,this,s)):i?i():(r=Error("Not Acceptable"),r.status=406,r.types=p(n).map(function(e){return e.value}),s(r)),this},e.attachment=function(e){return e&&this.type(d(e)),this.set("Content-Disposition",n(e)),this},e.set=e.header=function(t,e){var r,n;if(2===arguments.length)Array.isArray(e)?e=e.map(String):e+="","content-type"!=t.toLowerCase()||/;\s*charset\s*=/.test(e)||(r=i.charsets.lookup(e.split(";")[0]),r&&(e+="; charset="+r.toLowerCase())),this.setHeader(t,e);else for(n in t)this.set(n,t[n]);return this},e.get=function(e){return this.getHeader(e)},e.clearCookie=function(r,e){var t={expires:new Date(1),path:"/"};return this.cookie(r,"",e?o(t,e):t)},e.cookie=function(a,t,e){var i,s,r,n;if(e=o({},e),i=this.req.secret,s=e.signed,s&&!i)throw Error('cookieParser("secret") required for signed cookies');return"number"==typeof t&&(t=""+t),"object"==typeof t&&(t="j:"+JSON.stringify(t)),s&&(t="s:"+m(t,i)),"maxAge"in e&&(e.expires=new Date(Date.now()+e.maxAge),e.maxAge/=1e3),null==e.path&&(e.path="/"),r=f.serialize(a,t+"",e),n=this.get("Set-Cookie"),n&&(r=Array.isArray(n)?n.concat(r):[n,r]),this.set("Set-Cookie",r),this},e.location=function(e){var t=this.req;return"back"==e&&(e=t.get("Referrer")||"/"),this.set("Location",e),this},e.redirect=function(n){var e,o=n,r=302;2===arguments.length&&("number"==typeof arguments[0]?(r=arguments[0],o=arguments[1]):(t("res.redirect(ur, status): Use res.redirect(status, url) instead"),r=arguments[1])),this.location(o),o=this.get("Location"),this.format({text:function(){e=c[r]+". Redirecting to "+encodeURI(n)},html:function(){var t=l(n);e="<p>"+c[r]+'. Redirecting to <a href="'+t+'">'+t+"</a></p>"},"default":function(){e=""}}),this.statusCode=r,this.set("Content-Length",Buffer.byteLength(e)),"HEAD"===this.req.method&&this.end(),this.end(e)},e.vary=function(e){return!e||Array.isArray(e)&&!e.length?(t("res.vary(): Provide a field name"),this):(g(this,e),this)},e.render=function(i,e,t){var r,n,o;e=e||{},r=this,n=this.req,o=n.app,"function"==typeof e&&(t=e,e={}),e._locals=r.locals,t=t||function(e,t){return e?n.next(e):void r.send(t)},o.render(i,e,t)};